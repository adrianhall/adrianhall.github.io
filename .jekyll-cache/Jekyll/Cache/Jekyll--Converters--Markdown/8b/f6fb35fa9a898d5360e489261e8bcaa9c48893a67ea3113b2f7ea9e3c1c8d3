I"¥W<p>React Native is really good at straddling the line between native and JavaScript. There is a bridge between the two that allows you to call native code from JavaScript. This is awesome for including things that require a special touch. Most React Native developers will never need to worry about the bridge because libraries exist to wrap a lot of the common native libraries that you see in Android and iOS.</p>

<p>But what if you want to create a bridge library of your own? Thatâ€™s a whole other effort. Such an endeavor will require you to know Android (or Kotlin) and Objective-C (or Swift), plus the bridging technologies that React Native uses. I canâ€™t help you decide what to put in a native library, but this blog post is a walk through of creating a React Native bridge library that can be distributed on npmjs.org.</p>

<h2 id="step-1-prerequisites">Step 1: Prerequisites</h2>

<p>Scaffolding a bridge library is different from scaffolding an app. Fortunately, there is an easy tool to do the scaffolding. Unfortunately, you have to install it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> npm <span class="nb">install</span> <span class="nt">-g</span> react-native-create-library
</code></pre></div></div>

<p>You can use something like Visual Studio Code for all the code, but make sure you have the appropriate plugins so you get syntax highlighting and error detection. You will also want the latest versions of Android Studio and Xcode on your system. If you are doing a Windows library version, you will also want the .NET Core compiler on your system. Using a Mac is the only way to go here. Donâ€™t even attempt building a bridge library on a PC.</p>

<h2 id="step-2-scaffold-your-library">Step 2: Scaffold your library</h2>

<p>My particular library is going to be called <code class="highlighter-rouge">react-native-secure-keystore</code>. I want Android and iOS versions (sorry Windows) and the idea is to have a key-value store that is secured by your fingerprint. I use the following command line to create the library:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>react-native-create-library <span class="nt">--package-identifier</span> com.shellmonger.reactnative <span class="nt">--platforms</span> android,ios secure-keystore
</code></pre></div></div>

<p>This is not quite right, but itâ€™s close. Here is the tree structure that is created:</p>

<p><img src="/assets/images/2018-01-19-image1.png" alt="" /></p>

<p>There are a couple of points here.</p>

<ol>
  <li>The name of the directory is <code class="highlighter-rouge">secure-keystore</code> instead of <code class="highlighter-rouge">react-native-secure-keystore</code>. If I had put <code class="highlighter-rouge">react-native-secure-keystore</code> as the name, my classes would be <code class="highlighter-rouge">RNReactNativeSecureKeystoreModule.java</code> â€“ which is ugly. Renaming is easy (and we will take care of that in a moment.)</li>
  <li>Although <code class="highlighter-rouge">.gitignore</code> is added, a git repository is not included. You will have to create it.</li>
</ol>

<p>These problems are easily fixed:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">mv </span>secure-keystore react-native-secure-keystore
<span class="nv">$ </span><span class="nb">cd </span>react-native-secure-keystore
<span class="nv">$ </span>git init
<span class="nv">$ </span>git add <span class="nt">-A</span>
<span class="nv">$ </span>git commit <span class="nt">-m</span> <span class="s2">"Initial Commit"</span>
</code></pre></div></div>

<p>It would also be a good idea at this point to create a GitHub repository and add the GitHub repository as a remote. Also, do the other things you would normally do when created an npm package:</p>

<ul>
  <li>Update the <code class="highlighter-rouge">package.json</code> with repository, issues, author, home page and license.</li>
  <li>Update the <code class="highlighter-rouge">README.md</code> with relevant information.</li>
  <li>Add a <code class="highlighter-rouge">LICENSE.md</code> file.</li>
</ul>

<h2 id="step-3-write-some-code">Step 3: Write some code</h2>

<p>Getting to writing code didnâ€™t take too long. Letâ€™s take a look at how this works. The <code class="highlighter-rouge">index.js</code> file brings in the native modules and exposes them. You may want to export some JavaScript code that implements a particular interface, add TypeScript definitions, or any number of other things. However, the base functionality is that your compiled code is exposed as part of the <code class="highlighter-rouge">NativeModules</code> import from React Native. All the exposed methods are available as <code class="highlighter-rouge">NativeModules.RNSecureKeyStore.MethodName</code>. Note the <code class="highlighter-rouge">RNSecureKeyStore</code> comes from the arguments for the <code class="highlighter-rouge">react-native-create-library</code> command line tool.</p>

<p>In this example, there is an iOS version and an Android version. Each of these has a directory that can be opened in the appropriate workspace â€“ Xcode for iOS and Android Studio for Android. iOS has one module called <code class="highlighter-rouge">RNSecureKeyStore</code> and Android has a boilerplate file called <code class="highlighter-rouge">RNSecureKeystorePackage.java</code> (which you wonâ€™t touch) and functionally the same module called <code class="highlighter-rouge">RNSecureKeystoreModule.java</code>. You will have to add methods to each one. The default languages are Java and Objective-C.</p>

<p>Letâ€™s add a simple method that returns a boolean â€“ true if the device is ready to handle fingerprint authentication, false otherwise. Doing the Android version first, here is the code:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">shellmonger</span><span class="o">.</span><span class="na">reactnative</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">android.hardware.fingerprint.FingerprintManager</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">android.os.Build</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.facebook.react.bridge.Promise</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.facebook.react.bridge.ReactApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.facebook.react.bridge.ReactContextBaseJavaModule</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.facebook.react.bridge.ReactMethod</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.facebook.react.bridge.Callback</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">RNSecureKeystoreModule</span> <span class="kd">extends</span> <span class="nc">ReactContextBaseJavaModule</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ReactApplicationContext</span> <span class="n">reactContext</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">RNSecureKeystoreModule</span><span class="o">(</span><span class="nc">ReactApplicationContext</span> <span class="n">reactContext</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">super</span><span class="o">(</span><span class="n">reactContext</span><span class="o">);</span>
    <span class="k">this</span><span class="o">.</span><span class="na">reactContext</span> <span class="o">=</span> <span class="n">reactContext</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="s">"RNSecureKeystore"</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="cm">/**
   * PUBLIC REACT API
   *
   *  isAvailable()   Returns true if the fingerprint reader can be used
   */</span>
  <span class="nd">@ReactMethod</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">isAvailable</span><span class="o">(</span><span class="kd">final</span> <span class="nc">Promise</span> <span class="n">promise</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
      <span class="nc">FingerprintManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="n">getFingerprintManager</span><span class="o">();</span>
      <span class="kt">boolean</span> <span class="n">v</span> <span class="o">=</span> <span class="o">(</span><span class="n">manager</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">manager</span><span class="o">.</span><span class="na">isHardwareDetected</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">manager</span><span class="o">.</span><span class="na">hasEnrolledFingerprints</span><span class="o">());</span>
      <span class="n">promise</span><span class="o">.</span><span class="na">resolve</span><span class="o">(</span><span class="n">v</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">promise</span><span class="o">.</span><span class="na">reject</span><span class="o">(</span><span class="s">"ERR_UNEXPECTED_EXCEPTION"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="cm">/**
   * Returns fingerprint manager or null
   * @see https://stackoverflow.com/questions/34409969/how-to-check-device-compatibility-for-finger-print-authentication-in-android
   */</span>
  <span class="kd">private</span> <span class="nc">FingerprintManager</span> <span class="nf">getFingerprintManager</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">Build</span><span class="o">.</span><span class="na">VERSION</span><span class="o">.</span><span class="na">SDK_INT</span> <span class="o">&gt;=</span> <span class="nc">Build</span><span class="o">.</span><span class="na">VERSION_CODES</span><span class="o">.</span><span class="na">M</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="o">(</span><span class="nc">FingerprintManager</span><span class="o">)</span> <span class="n">reactContext</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">reactContext</span><span class="o">.</span><span class="na">FINGERPRINT_SERVICE</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>I generally produce two library files â€“ the one ending in <code class="highlighter-rouge">Module.java</code> contains just the API being exposed to React. There is another one that contains the actual code. This allows me to test the library separately from the bridge a lot easier.</p>

<p>The <code class="highlighter-rouge">ReactMethod</code> attribute indicates that the method is exposed to React. It always takes a Promise as the last argument, and you need to either resolve or reject it. I always try to wrap my entire method in a try/catch and reject based on the exception. This ensures any exceptions can be handled in JavaScript code instead of crashing the app.</p>

<p>Android code may require permissions â€“ there is an <code class="highlighter-rouge">AndroidManifest.xml</code> file to do that for you. In this case, add the <code class="highlighter-rouge">USE_FINGERPRINT</code> permission.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;manifest</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span> <span class="na">package=</span><span class="s">"com.shellmonger.reactnative"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.USE_FINGERPRINT"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/manifest&gt;</span>
</code></pre></div></div>

<p>Itâ€™s a good idea to open the <code class="highlighter-rouge">android</code> directory in Android Studio so that all the nice IDE features for Android are at your disposal â€“ things like import auto-complete. If you do this, Android Studio will prompt you for upgrading the project. Donâ€™t do it! This will implement a gradle version that is incompatible with React Native and cause all sorts of problems.</p>

<p>Switching over to the iOS side, I donâ€™t like Objective-C. However, it is a necessary evil when working with bridging libraries, mostly because you cannot compile a static library with Swift. Even if you really want to write your library in Swift, you have to do that and then bridge it into Objective-C. So you might as well go the whole way and write the whole thing in Objective-C. (And yes, I do hope that this changes drastically soon so you can use the more modern languages). Letâ€™s look at our iOS files. Firstly, the <code class="highlighter-rouge">RNSecureKeystore.m</code> file:</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import "RNSecureKeystore.h"
#import &lt;LocalAuthentication/LocalAuthentication.h&gt;
</span>
<span class="k">@implementation</span> <span class="nc">RNSecureKeystore</span>

<span class="n">RCT_EXPORT_MODULE</span><span class="p">();</span>

<span class="n">RCT_EXPORT_METHOD</span><span class="p">(</span><span class="n">isAvailable</span><span class="o">:</span><span class="p">(</span><span class="n">RCTPromiseResolveBlock</span><span class="p">)</span><span class="n">resolve</span> <span class="n">rejecter</span><span class="o">:</span><span class="p">(</span><span class="n">RCTPromiseRejectBlock</span><span class="p">)</span><span class="n">reject</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">LAContext</span> <span class="o">*</span><span class="n">context</span> <span class="o">=</span> <span class="p">[[</span><span class="n">LAContext</span> <span class="nf">alloc</span><span class="p">]</span> <span class="nf">init</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">([</span><span class="n">context</span> <span class="nf">canEvaluatePolicy</span><span class="p">:</span><span class="n">LAPolicyDeviceOwnerAuthenticationWithBiometrics</span> <span class="nf">error</span><span class="p">:</span><span class="nb">NULL</span><span class="p">])</span> <span class="p">{</span>
        <span class="n">resolve</span><span class="p">(</span><span class="err">@</span><span class="p">(</span><span class="nb">YES</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">resolve</span><span class="p">(</span><span class="err">@</span><span class="p">(</span><span class="nb">NO</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>This is (to me, at least) ugly code. However, Iâ€™m just copying something I got from <a href="https://stackoverflow.com/questions/24158062/how-to-use-touch-id-sensor-in-ios-8">Stack Overflow</a> in this instance (much like the Android code from earlier). I donâ€™t need to change anything else.</p>

<h2 id="testing-your-package">Testing your package</h2>

<p>To test a React Native bridge library, itâ€™s generally useful to write a test application. Here is how I do it:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>yarn <span class="nb">link</span>
<span class="nv">$ </span>react-native init example
<span class="nv">$ </span><span class="nb">cd </span>example
<span class="nv">$ </span>yarn <span class="nb">link </span>react-native-secure-keystore
<span class="nv">$ </span>react-native <span class="nb">link </span>react-native-secure-keystore
</code></pre></div></div>

<p>The first <code class="highlighter-rouge">yarn link</code> command registers the local copy of my library with yarn. Then I create a normal React Native app. Iâ€™m using <code class="highlighter-rouge">react-native init</code> instead of <code class="highlighter-rouge">create-react-native-app</code> because Iâ€™m going to link a library. The second <code class="highlighter-rouge">yarn link</code> links the local copy I registered earlier into the current project. Then I do the <code class="highlighter-rouge">react-native link</code> command to link all the native code bridges (not just mine).</p>

<p>The next step is to adjust my example app to exercise the new code. The essence of the new code is this:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">SecureKeystore</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">react-native-secure-keystore</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">class</span> <span class="nx">App</span> <span class="kd">extends</span> <span class="nx">React</span><span class="p">.</span><span class="nx">Component</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="nx">props</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">props</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="p">{</span> <span class="na">isAvailable</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span> <span class="na">ready</span><span class="p">:</span> <span class="kc">false</span> <span class="p">};</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">componentDidMount</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">isAvailable</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">SecureKeystore</span><span class="p">.</span><span class="nx">isAvailable</span><span class="p">();</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span> <span class="nx">isAvailable</span><span class="p">,</span> <span class="na">ready</span><span class="p">:</span> <span class="kc">true</span> <span class="p">};</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Error = </span><span class="dl">'</span><span class="p">,</span> <span class="nx">ex</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">render</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Do something with this.state here</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">isAvailable</code> constant should be a boolean. Since all bridge methods are async, I set it in state using an async lifecycle event handler.</p>

<p>Now, letâ€™s run it with react-native run-ios! You will note that almost immediately, the <code class="highlighter-rouge">isAvailable</code> method returns false. In the iOS simulator, you can simulate TouchID. Go to the Simulator and choose <strong>Hardware</strong> -&gt; <strong>Touch ID</strong> -&gt; <strong>Enroll</strong>. Then reload the app â€“ note that <code class="highlighter-rouge">isAvailable</code> is now true.</p>

<p>Running in the Android emulator using <code class="highlighter-rouge">react-native run-android</code> is a little trickier. The emulator you use must have support for the hardware. If you have a real device, that may be an easier method.</p>

<h2 id="writing-tests">Writing tests</h2>

<p>One of the problems you will encounter in this is how to test your library on real devices. Fortunately, there are services out there (<a href="https://aws.amazon.com/devicefarm">AWS Device Farm</a> is the one I use) that allow you to test your library on a wide variety of devices. What you want to do in this case is write an app that exercises the library through a set of screens. For example, you might have a main navigation where you press buttons to call each routine and fill in a text box with the result. Then, write UI tests in <a href="https://developer.apple.com/library/content/documentation/DeveloperTools/Conceptual/testing_with_xcode/chapters/09-ui_testing.html#//apple_ref/doc/uid/TP40014132-CH13-DontLinkElementID_6">XCUI Test</a>, <a href="https://developer.android.com/training/testing/ui-testing/espresso-testing.html">Espresso</a> or <a href="http://appium.io/">Appium</a> to exercise the app. Of these, only Appium is cross-platform and it is fully supported by AWS Device Farm.</p>
:ET