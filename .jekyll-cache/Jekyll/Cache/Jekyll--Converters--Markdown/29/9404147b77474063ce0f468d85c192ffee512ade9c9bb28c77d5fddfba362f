I"¥[<p>Thus far in this series, I‚Äôve <a href="/android/tailwind%20photos/2019/08/15/tailwind-photos-1/">established a decent splash screen and auth trigger page</a>, and <a href="/android/tailwind%20photos/2019/08/17/tailwind-photos-2/">integrated Facebook authentication</a> into my app.  The next authentication technique is <a href="https://developers.google.com/identity/sign-in/android/start-integrating">Google Auth</a>.  If you followed along with the Facebook auth integration, you will know that I separated the actual Facebook part of it into a separate class, allowing me to clean up the code in the actual activity.  I also established provider-agnostic models for the authenticated user, which I will re-use in this post.</p>

<p>Onto Google!  It follows the same pattern as Facebook - you do some work to configure a project on the Google Developers site, then integrate some code in your app.  Along the way, you will need to provide some data about your app to Google, and take some information from Google to hook the app to the right configuration.</p>

<h2 id="getting-your-signing-certificate-information">Getting your signing certificate information</h2>

<p>Before we begin with the Google side of things, let‚Äôs talk about the signing certificate.  This is the same as the ‚Äúkey hash‚Äù that was provided for Facebook, so we already have a method of getting the signing certificate.  It‚Äôs just in the wrong form (which - admittedly - we could correct).  However, I do want to provide an alternate to using code - the <code class="highlighter-rouge">keytool</code> command line tool.</p>

<ol>
  <li>Install a Java JDK.  I use <a href="https://www.azul.com/downloads/zulu-community/?&amp;os=windows">the Azul Zulu Community Edition</a> since I don‚Äôt like what Oracle did to the licensing.  However, you can use any version you want.</li>
  <li>Locate the <code class="highlighter-rouge">keytool</code>.  Ensure the location is on your <code class="highlighter-rouge">PATH</code>.  How to do this depends on your platform, and Google is your friend.  For Azul Zulu, the installer adds it to your path.</li>
  <li>Run the following command:</li>
</ol>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">keytool <span class="nt">-list</span> <span class="nt">-v</span> <span class="nt">-keystore</span> .android/debug.keystore</code></pre></figure>

<p>The password is <code class="highlighter-rouge">android</code> for  debug keystore.  You will see output similar to the following:</p>

<p><img src="/assets/images/tailwinds-3-image1.png" alt="" /></p>

<p>The highlighted content (next to SHA-1) is what you will need.  You can find <a href="https://developers.google.com/android/guides/client-auth">the full instructions in the Google Guides</a>.</p>

<h2 id="the-google-side">The Google side</h2>

<p>You have a Google account, right?  Then go to the <a href="https://developers.google.com/identity/sign-in/android/start-integrating">Google documentation</a> and click the <strong>Configure a project</strong> button.</p>

<blockquote>
  <p>You can also configure the service side by going to the <a href="https://console.developers.google.com">Google API Console</a> and creating a project from scratch.  I find this to be more cumbersome.  I like the wizard that the <strong>Configure a project</strong> link provides.</p>
</blockquote>

<p>If you already have a project, then you can select it from a drop-down and just use that, alternatively (and this is what I am doing), select <strong>Create a new project</strong>.  If you don‚Äôt have any Google projects, the project selector is skipped and you get deposited right at the ‚ÄúCreate a new project‚Äù step.</p>

<ul>
  <li>Enter a name for the project.  I called mine <code class="highlighter-rouge">Tailwind Photos</code>.</li>
  <li>Enter a product name.  Again, I entered <code class="highlighter-rouge">Tailwind Photos</code>.  Since this is the name that the user sees, ensure it matches your brand.</li>
  <li>In <strong>Configure your OAuth client</strong>, select <strong>Android</strong>.
    <ul>
      <li>Enter the package name of your app from your <code class="highlighter-rouge">AndroidManifest.xml</code> - mine is <code class="highlighter-rouge">com.tailwind.apps.photos</code></li>
      <li>Enter the SHA-1 signing certificate you retrieved before you started this section in the box provided.</li>
    </ul>
  </li>
</ul>

<p>This will give you a Client ID and Client Secret.  Copy these off somewhere.  Do not put them in your Android app!  Once you have copied them off, click <strong>DONE</strong>.</p>

<blockquote>
  <p>The Google client relies on the signing certificate for your app to identify itself.  You need to use the same signing certificate on all your clients.  If you develop (as I do) on multiple machines, you will need to add additional Android clients:</p>
  <ul>
    <li>Go to the <a href="https://console.developers.google.com">Google Developers Console</a> and sign in.</li>
    <li>Select your app, if required.  If you only have one app, it will be automatically selected for you.</li>
    <li>Click <strong>Credentials</strong> in the left-hand menu.</li>
    <li>Click <strong>Create credential</strong>.</li>
    <li>Select <strong>Android</strong>.</li>
    <li>Fill in the new signing certificate SHA-1 and the same package name.</li>
    <li>Click <strong>Create</strong>.
You should now be able to sign in from your new development box.</li>
  </ul>
</blockquote>

<p>Finally, when you go through this process, the Google systems will create a web client for you with a unique client ID and client secret.  You need the client ID later on:</p>

<ul>
  <li>Go to the <a href="https://console.developers.google.com">Google Developers Console</a> and sign in.</li>
  <li>Select your app, if required.  If you only have one app, it will be automatically selected for you.</li>
  <li>Click <strong>Credentials</strong> in the left-hand menu.</li>
  <li>Look for ‚ÄúWeb client (Auto-created for Google Sign-in)‚Äù.</li>
  <li>Copy the client ID associated with this client.</li>
</ul>

<p>Now, let‚Äôs move to the app side!</p>

<h2 id="the-app-side">The App side</h2>

<p>First, I said we needed the client ID for the web client.  Let‚Äôs put that in our <code class="highlighter-rouge">res/values/strings.xml</code> file:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;resource&gt;</span>
	<span class="c">&lt;!-- the rest of the strings are here --&gt;</span>

	<span class="c">&lt;!-- Google Sign-in --&gt;</span>
	<span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">"google_client_id"</span><span class="nt">&gt;</span>1234567890-abcdefghijklmnopqr.apps.googleusercontent.com<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;/resources&gt;</span></code></pre></figure>

<blockquote>
  <p>It‚Äôs ok to include client IDs in the app - they aren‚Äôt considered security information.  However, you should never include client secrets in mobile apps.  Mobile apps can be decoded once they are released.  Any string you include in your app will be available for anyone to see.</p>
</blockquote>

<p>Just replace my (obviously faked) client ID above with the one your copied from the Google developers console earlier.  Next, as with all these integrations, there is a library to add to the module-level <code class="highlighter-rouge">build.gradle</code> file:</p>

<figure class="highlight"><pre><code class="language-gradle" data-lang="gradle"><span class="k">dependencies</span> <span class="o">{</span>
	<span class="c1">// Rest of the dependencies go here	</span>
	<span class="n">implementation</span> <span class="s1">'com.facebook.android:facebook-android-sdk:5.2.0'</span>
	<span class="n">implementation</span> <span class="s1">'com.google.android.gms:play-services-auth:17.0.0'</span>
<span class="o">}</span></code></pre></figure>

<p>Like the Facebook mechanism, I want to abstract the code for handling Google.  I‚Äôm going to try and use a similar API surface.  Here is the code for the <code class="highlighter-rouge">AuthenticatorActivity</code> (at least the important bits):</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="kd">class</span> <span class="nc">AuthenticatorActivity</span> <span class="p">:</span> <span class="n">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">private</span> <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">fbManager</span><span class="p">:</span> <span class="n">FacebookManager</span>
	<span class="k">private</span> <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">googleManager</span><span class="p">:</span> <span class="n">GoogleManager</span>

	<span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="nv">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
		<span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
		<span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_authenticator</span><span class="p">)</span>

		<span class="cm">/* FACEBOOK AUTH INITIALIZATION */</span>
		<span class="n">fbManager</span> <span class="p">=</span> <span class="n">FacebookManager</span><span class="p">()</span>
		<span class="n">fbManager</span>
			<span class="p">.</span><span class="n">onSuccess</span> <span class="p">{</span> <span class="n">user</span> <span class="p">-&gt;</span> <span class="n">moveToNextActivity</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
			<span class="p">.</span><span class="n">onFailure</span> <span class="p">{</span> <span class="n">error</span> <span class="p">-&gt;</span> <span class="n">displayErrorAlert</span><span class="p">(</span><span class="s">"Facebook"</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">}</span>
		<span class="n">facebook_login</span><span class="p">.</span><span class="n">setOnClickListener</span> <span class="p">{</span>
			<span class="n">fbManager</span><span class="p">.</span><span class="n">beginSignin</span><span class="p">(</span><span class="k">this</span><span class="nd">@AuthenticatorActivity</span><span class="p">)</span>
		<span class="p">}</span>

		<span class="cm">/* GOOGLE AUTH INITIALIZATION */</span>
		<span class="n">googleManager</span> <span class="p">=</span> <span class="n">GoogleManager</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
		<span class="n">googleManager</span>
			<span class="p">.</span><span class="n">onSuccess</span> <span class="p">{</span> <span class="n">user</span> <span class="p">-&gt;</span> <span class="n">moveToNextActivity</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
			<span class="p">.</span><span class="n">onFailure</span> <span class="p">{</span> <span class="n">error</span> <span class="p">-&gt;</span> <span class="n">displayErrorAlert</span><span class="p">(</span><span class="s">"Google"</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">}</span>
		<span class="n">google_login</span><span class="p">.</span><span class="n">setOnClickListener</span> <span class="p">{</span>
			<span class="n">googleManager</span><span class="p">.</span><span class="n">beginSignin</span><span class="p">(</span><span class="k">this</span><span class="nd">@AuthenticatorActivity</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">override</span> <span class="k">fun</span> <span class="nf">onActivityResult</span><span class="p">(</span><span class="nv">requestCode</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="nv">resultCode</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="nc">Intent</span><span class="p">?)</span> <span class="p">{</span>
		<span class="k">super</span><span class="p">.</span><span class="n">onActivityResult</span><span class="p">(</span><span class="n">requestCode</span><span class="p">,</span> <span class="n">resultCode</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
		<span class="n">fbManager</span><span class="p">.</span><span class="n">onActivityResult</span><span class="p">(</span><span class="n">requestCode</span><span class="p">,</span> <span class="n">resultCode</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
		<span class="n">googleManager</span><span class="p">.</span><span class="n">onActivityResult</span><span class="p">(</span><span class="n">requestCode</span><span class="p">,</span> <span class="n">resultCode</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// The rest of the class is unchanged</span>
<span class="p">}</span></code></pre></figure>

<p>I‚Äôve been deliberate with the API surface here.  I want this side of things to be very readable and as close to the <code class="highlighter-rouge">FacebookManager</code> API as possible.  It‚Äôs almost exactly the same.  In face, the only thing that is different is that I have to pass a <code class="highlighter-rouge">Context</code> to the constructor for Google.  Let‚Äôs take a look at the manager:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="k">typealias</span> <span class="n">OnGoogleSuccessCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">AuthenticatedUser</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
<span class="k">typealias</span> <span class="n">OnGoogleFailureCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">Exception</span><span class="p">?)</span> <span class="p">-&gt;</span> <span class="n">Unit</span>

<span class="kd">class</span> <span class="nc">GoogleManager</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="nc">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kd">val</span> <span class="py">GOOGLE_SIGN_IN_RC</span> <span class="p">=</span> <span class="m">6001</span>
	<span class="p">}</span>

	<span class="k">private</span> <span class="kd">var</span> <span class="py">signInClient</span><span class="p">:</span> <span class="n">GoogleSignInClient</span>
	<span class="k">private</span> <span class="kd">var</span> <span class="py">onSuccessCallback</span><span class="p">:</span> <span class="n">OnGoogleSuccessCallback</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
	<span class="k">private</span> <span class="kd">var</span> <span class="py">onFailureCallback</span><span class="p">:</span> <span class="n">OnGoogleFailureCallback</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

	<span class="n">init</span> <span class="p">{</span>
		<span class="kd">val</span> <span class="py">options</span> <span class="p">=</span> <span class="n">GoogleSignInOptions</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span><span class="n">GoogleSignInOptions</span><span class="p">.</span><span class="n">DEFAULT_SIGN_IN</span><span class="p">)</span>
			<span class="p">.</span><span class="n">requestIdToken</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">getString</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">google_client_id</span><span class="p">))</span>
			<span class="p">.</span><span class="n">requestEmail</span><span class="p">()</span>
			<span class="p">.</span><span class="n">build</span><span class="p">()</span>
		<span class="n">signInClient</span> <span class="p">=</span> <span class="n">GoogleSignIn</span><span class="p">.</span><span class="n">getClient</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">fun</span> <span class="nf">onSuccess</span><span class="p">(</span><span class="nv">callback</span><span class="p">:</span> <span class="nc">OnGoogleSuccessCallback</span><span class="p">):</span> <span class="nc">GoogleManager</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="n">onSuccessCallback</span> <span class="p">=</span> <span class="n">callback</span>
		<span class="k">return</span> <span class="k">this</span>
	<span class="p">}</span>

	<span class="k">fun</span> <span class="nf">onFailure</span><span class="p">(</span><span class="nv">callback</span><span class="p">:</span> <span class="nc">OnGoogleFailureCallback</span><span class="p">):</span> <span class="nc">GoogleManager</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="n">onFailureCallback</span> <span class="p">=</span> <span class="n">callback</span>
		<span class="k">return</span> <span class="k">this</span>
	<span class="p">}</span>

	<span class="k">fun</span> <span class="nf">beginSignin</span><span class="p">(</span><span class="nv">activity</span><span class="p">:</span> <span class="nc">Activity</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">activity</span><span class="p">.</span><span class="n">startActivityForResult</span><span class="p">(</span><span class="n">signInClient</span><span class="p">.</span><span class="n">signInIntent</span><span class="p">,</span> <span class="n">GOOGLE_SIGN_IN_RC</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">fun</span> <span class="nf">onActivityResult</span><span class="p">(</span><span class="nv">requestCode</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="nv">resultCode</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="nc">Intent</span><span class="p">?)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">requestCode</span> <span class="p">==</span> <span class="n">GOOGLE_SIGN_IN_RC</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">val</span> <span class="py">task</span> <span class="p">=</span> <span class="n">GoogleSignIn</span><span class="p">.</span><span class="n">getSignedInAccountFromIntent</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="k">try</span> <span class="p">{</span>
				<span class="kd">val</span> <span class="py">account</span> <span class="p">=</span> <span class="n">task</span><span class="p">.</span><span class="n">getResult</span><span class="p">(</span><span class="n">ApiException</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span> <span class="o">?:</span> <span class="k">throw</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s">"account is null"</span><span class="p">)</span>
				<span class="kd">val</span> <span class="py">idToken</span> <span class="p">=</span> <span class="n">account</span><span class="p">.</span><span class="n">idToken</span> <span class="o">?:</span> <span class="k">throw</span> <span class="n">RuntimeException</span><span class="p">(</span><span class="s">"account ID is null"</span><span class="p">)</span>
				<span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">AuthenticatedUser</span><span class="p">(</span><span class="n">idToken</span><span class="p">,</span> <span class="n">AuthenticationProvider</span><span class="p">.</span><span class="n">GOOGLE</span><span class="p">,</span>
					<span class="n">account</span><span class="p">.</span><span class="n">displayName</span> <span class="o">?:</span> <span class="s">"Unknown"</span><span class="p">,</span> <span class="n">account</span><span class="p">.</span><span class="n">email</span> <span class="o">?:</span> <span class="s">""</span><span class="p">)</span>
				<span class="n">onSuccessCallback</span><span class="o">?.</span><span class="n">invoke</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
			<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nv">error</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">onFailureCallback</span><span class="o">?.</span><span class="n">invoke</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>This code is pretty much taken from the Google sign-in instructions.  The one wrinkle is that you need to pass the client ID to <code class="highlighter-rouge">.requestIdToken()</code> to get an OAuth ID token that is used to authenticate with your backend.  We haven‚Äôt got there yet, but we will.</p>

<p>There are two possible errors that you may run into:</p>

<ul>
  <li>An <code class="highlighter-rouge">ApiException</code> generally indicates that you have messed up the Google console configuration.  Check that the information in the Google developers console matches your app exactly.  The SHA-1 hash and the package identifier have to match.</li>
  <li>If the <code class="highlighter-rouge">idToken</code> is null, then the web client ID is probably wrong.  Again, check that the client ID you included in the <code class="highlighter-rouge">strings.xml</code> file matches the client ID in the Google developers console for the <code class="highlighter-rouge">Web client</code> OAuth credential.</li>
</ul>

<h2 id="next-steps">Next steps</h2>

<p>You should go through the process of signing in.  You will need to set up your Google account on the emulator the first time through, but it won‚Äôt ask for your password after that - it will just switch seamlessly between asking and returning.  In most cases, you won‚Äôt even get prompted - it will just return.</p>

<p>Next time, I‚Äôm going to cover Microsoft authentication (which can cover both enterprise authentication and outlook.com authentication).  Until then, the code is <a href="https://github.com/adrianhall/tailwind-photos-for-android/tree/blog-3">on my GitHub repository</a>.</p>
:ET