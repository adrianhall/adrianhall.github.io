I"ôó<p>This will be an in-depth series on authentication with <a href="https://aws-amplify.github.io?utm_source=da&amp;utm_medium=blog&amp;utm_campaign=adrianha">AWS Amplify</a>. Here are the topics I am going to cover, and I will update each blog with the links as I complete the articles.</p>

<ul>
  <li><a href="/android/2018/09/18/auth-with-aws-amplify-1/">The basics‚Ää-‚Ääa username/password system</a>.</li>
  <li><a href="/android/2018/09/23/auth-with-aws-amplify-2/">Customizing the UI</a>.</li>
  <li><a href="/android/2018/10/01/auth-with-aws-amplify-3/">Authenticating with Facebook</a>.</li>
  <li><a href="/android/2018/10/08/auth-with-aws-amplify-4/">Authenticating with Google</a>.</li>
  <li><a href="/android/2018/10/15/auth-with-aws-amplify-5/">Using third-party authentication providers</a>.</li>
  <li><a href="/android/2018/10/22/auth-with-aws-amplify-6/">Using Time-based One-time passwords (TOTP)</a>.</li>
  <li><a href="/android/2018/10/29/auth-with-aws-amplify-7/">Using Biometric authentication</a>.</li>
  <li><a href="/android/2018/11/05/auth-with-aws-amplify-8/">Doing fraud protection and analytics</a>.</li>
</ul>

<p>I‚Äôm not going to cover integrating with Active Directory in this series as there is an excellent walk through of the process on the <a href="https://aws.amazon.com/blogs/mobile/building-adfs-federation-for-your-web-app-using-amazon-cognito-user-pools/">AWS Mobile Blog</a>. If you want to see a topic covered that I haven‚Äôt suggested, <a href="https://twitter.com/FizzyInTheHall">send me a message</a> on Twitter.</p>

<h2 id="so-the-basics">So, the basics?</h2>

<p>Authentication and authorization scares most people. From a pure product perspective, you are putting a barrier between your app and the user. In return, you get to track the user as a user instead of a device. The user gets portability of data‚Ää‚Äî‚Ääthe ability to see their data on multiple devices. So, as a user, we see authentication as a necessary evil.</p>

<p>As developers, we can still make it easier for our users by following some pretty basic patterns.</p>

<ol>
  <li>Use a service. There is practically no reason to be implementing an authentication provider yourself.</li>
  <li>Use social authentication whenever you can. If you need username and password, ask yourself why you need it.</li>
  <li>Don‚Äôt rely on one social authentication provider. Let your user choose how to authenticate.</li>
  <li>Keep it simple‚Ää‚Äî‚Ääminimal information requests.</li>
  <li>If you are using username / password authentication, ensure you secure the information adequately.</li>
  <li>Cache the user credentials and re-use them whenever possible to reduce the number of times the user is asked for authentication.</li>
</ol>

<p>There are reasons why you should not use social authentication. Banks and shopping apps comes to mind. However, most apps don‚Äôt fall into that category, so you should be able to use social authentication.</p>

<p>So, how does authentication work within AWS? This is the diagram from <a href="https://docs.aws.amazon.com/cognito/latest/developerguide/what-is-amazon-cognito.html">the AWS documentation</a>:</p>

<p><img src="/assets/images/2018-09-18-image1.png" alt="The Authentication Flow" class="center-image" /></p>

<p>Let‚Äôs replace ‚ÄúUser pool‚Äù with ‚ÄúAuthentication provider‚Äù. The process is fairly simple. You get <a href="https://en.wikipedia.org/wiki/JSON_Web_Token">a token</a> from an <a href="https://openid.net/connect/">OpenID Connect (OIDC)</a> authentication provider. With a couple of AWS services, this is enough‚Ää‚Äî‚Ääjust start passing that token to AWS AppSync or Amazon API Gateway to get access to the resources. Amazon Cognito user pools is an OIDC compatible service that you can use for username and password authentication.</p>

<p>If you want to access any other service (aside from <a href="https://aws.amazon.com/appsync">AWS AppSync</a> and <a href="https://aws.amazon.com/api-gateway/">Amazon API Gateway</a>), then you need to sign your requests to the AWS service. That requires an access key and secret key so that you can be associated with an IAM policy. Amazon Cognito Federated Identities (also known as an Identity pool) provides short-lived identities for this purpose. The app sends the token you received from the OIDC authentication provider to the Identity pool and it will send the app appropriate credentials back that you can use for up to an hour. The AWS Mobile SDK takes care of most of this for you, so this is behind the scenes.</p>

<h2 id="when-do-you-authenticate-your-users">When do you authenticate your users?</h2>

<p>There are basically three times you may want to authenticate your users:</p>

<ol>
  <li>When the user initiates an authentication request.</li>
  <li>When the user requests to enter a protected screen in the app.</li>
  <li>When the user requests access to protected data in the app.</li>
</ol>

<p>Most demonstration apps wrap the entire app in an authentication request. While this is easy to implement, it‚Äôs not friendly to the user, and I discourage its use. However, you may find it useful to check authentication and redirect users to the authentication screen when needed. For example, you might have a catalog of ‚Äústuff‚Äù (say videos) and provide the list to unauthenticated users, but details (e.g. the video itself) to authenticated users.</p>

<p>I normally like to write apps where authentication is not required, but the user gets additional features when authentication is provided. For example, I may write a notes app that stores data locally. However, when the user logs in, the data is stored in the cloud and can be accessed from other devices or on the web. As a result, I generally provide a navigation drawer with a Sign In / Sign Out link.</p>

<p>The final technique is when users request access to protected data. Let‚Äôs take that video app example again. If you had some videos that were available unauthenticated, then you might check the authentication state of the user prior to presenting the video and make a decision on whether to ask for authentication there.</p>

<p>In all cases, the authentication is done by a new <code class="highlighter-rouge">Activity</code> that does the work of authenticating the users. This activity is provided by the AWS Mobile SDK.</p>

<h2 id="setting-up-usernamepassword-authentication">Setting up username/password authentication</h2>

<p>Before we get started, we are going to be using the <a href="https://aws-amplify.github.io?utm_source=da&amp;utm_medium=blog&amp;utm_campaign=adrianha">AWS Amplify</a> Toolchain for this purpose. If you have seen my other blogs, you will know this is incredibly easy to get started:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">npm <span class="nb">install</span> @aws-amplify/cli
amplify configure</code></pre></figure>

<p>This is a one-time install. You will need to configure the AWS CLI or create an access key and secret key for usage. Check out the <a href="https://aws-amplify.github.io/media/get_started?utm_source=da&amp;utm_medium=blog&amp;utm_campaign=adrianha">Get Started tutorial</a> for more details on this (there is a video walking you through the process).</p>

<p>Next, let‚Äôs initialize a project. Pick any Android project. I‚Äôm using a Kotlin-based project for this, but you can use whatever project you want. The information translates between Java and Kotlin really easily.</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">amplify init</code></pre></figure>

<p>You will be guided through the process of setting up the project. Make sure <code class="highlighter-rouge">android</code> is selected at the appropriate time. Next, let‚Äôs add authentication:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">amplify add auth</code></pre></figure>

<p>If you have added other services, this would be <code class="highlighter-rouge">amplify update auth</code> instead. That‚Äôs because you will have set up a ‚Äúguest‚Äù authentication service (which comprises an Amazon Cognito identity pool and an unauthenticated role in AWS IAM).</p>

<p>The first question is whether you want to use the default settings or not. The default settings are authentication via Amazon Cognito user pools with username and password. Sign-ups will be protected by a multi-factor authentication token sent via phone or email. If this describes you scenario, then use the default settings. However, let‚Äôs take a look at our own configuration:</p>

<p><img src="/assets/images/2018-09-18-image2.png" alt="Answers to the CLI Questions" class="center-image" /></p>

<p>That is a lot of settings, and they are intimidating. However, most of them are straight forward and they allow you to configure your authentication service very specifically. If you want to change anything, you can run <code class="highlighter-rouge">amplify update auth</code> at any time in the future.</p>

<p>Behind the scenes, there is a CloudFormation template that is generated to create all the resources that are required here. Now, let‚Äôs deploy this!</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">amplify push</code></pre></figure>

<p>There is an approval (say yes) and then the resources will be deployed to the AWS cloud for you. In addition, a new <code class="highlighter-rouge">awsconfiguration.json</code> file will be generated within your apps <code class="highlighter-rouge">res/raw</code> directory for you to use.</p>

<h2 id="add-some-dependencies">Add some dependencies</h2>

<p>Here is the Gradle dependencies for implementing authentication:</p>

<figure class="highlight"><pre><code class="language-gradle" data-lang="gradle"><span class="k">dependencies</span> <span class="o">{</span>
    <span class="c1">// AWS Dependencies</span>
    <span class="n">implementation</span> <span class="s2">"com.amazonaws:aws-android-sdk-core:$versions.aws"</span>
    <span class="n">implementation</span> <span class="s2">"com.amazonaws:aws-android-sdk-auth-core:$versions.aws"</span>
    <span class="n">implementation</span><span class="o">(</span><span class="s2">"com.amazonaws:aws-android-sdk-auth-userpools:$versions.aws@aar"</span><span class="o">)</span> <span class="o">{</span> <span class="n">transitive</span> <span class="o">=</span> <span class="kc">true</span> <span class="o">}</span>
    <span class="n">implementation</span><span class="o">(</span><span class="s2">"com.amazonaws:aws-android-sdk-auth-ui:$versions.aws"</span><span class="o">)</span> <span class="o">{</span> <span class="n">transitive</span> <span class="o">=</span> <span class="kc">true</span> <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>The <code class="highlighter-rouge">auth-core</code> dependency is required for just about everything. The <code class="highlighter-rouge">auth-ui</code> dependency provides the in-built UI, and the <code class="highlighter-rouge">auth-userpools</code> dependency provides the Amazon Cognito user pools access. Most of the AWS Mobile SDK works with lower API levels (e.g. API level 15), but the Auth UI requires API level 23. If you are targeting API levels lower than 23, you will have to write your own UI. (That‚Äôs going to be covered in a later article).</p>

<p>Make sure you also add the <code class="highlighter-rouge">INTERNET</code> permission to the app.</p>

<h2 id="show-me-the-code">Show me the code!</h2>

<p>The code for the basics is simple. First, I find it normal to create an <code class="highlighter-rouge">AWSService</code> class that provides access to the configuration and credentials provider:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="k">package</span> <span class="nn">com.amazonaws.mobile.samples.picturefeed.services.aws</span>

<span class="k">import</span> <span class="nn">android.content.Context</span>
<span class="k">import</span> <span class="nn">com.amazonaws.auth.AWSCredentialsProvider</span>
<span class="k">import</span> <span class="nn">com.amazonaws.mobile.auth.core.IdentityManager</span>
<span class="k">import</span> <span class="nn">com.amazonaws.mobile.auth.userpools.CognitoUserPoolsSignInProvider</span>
<span class="k">import</span> <span class="nn">com.amazonaws.mobile.config.AWSConfiguration</span>

<span class="kd">class</span> <span class="nc">AWSService</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="nc">Context</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">configuration</span> <span class="p">=</span> <span class="n">AWSConfiguration</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">identityManager</span> <span class="p">:</span> <span class="n">IdentityManager</span>
    <span class="kd">val</span> <span class="py">credentialsProvider</span> <span class="p">:</span> <span class="n">AWSCredentialsProvider</span>

    <span class="n">init</span> <span class="p">{</span>
        <span class="n">identityManager</span> <span class="p">=</span> <span class="n">IdentityManager</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">configuration</span><span class="p">)</span>
        <span class="n">identityManager</span><span class="p">.</span><span class="n">addSignInProvider</span><span class="p">(</span><span class="n">CognitoUserPoolsSignInProvider</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
        <span class="n">IdentityManager</span><span class="p">.</span><span class="n">setDefaultIdentityManager</span><span class="p">(</span><span class="n">identityManager</span><span class="p">)</span>
        <span class="n">credentialsProvider</span> <span class="p">=</span> <span class="n">identityManager</span><span class="p">.</span><span class="n">credentialsProvider</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The important line here is the <code class="highlighter-rouge">.addSignInProvider()</code> call. This registers Amazon Cognito User Pools as a sign-in provider and links the identity pool with the user pool within the AWS Mobile SDK.</p>

<p>This provides three elements:</p>

<ul>
  <li><code class="highlighter-rouge">configuration</code> is the internal representation of the awsconfiguration.json file</li>
  <li><code class="highlighter-rouge">identityManager</code> is an internally federated authentication mechanism that submits tokens to the credentials provider as required.</li>
  <li><code class="highlighter-rouge">credentialsProvider</code> is the identity pool linkage, asking for IAM identities on your behalf based on the authentication state.</li>
</ul>

<p>The good news is really this‚Ää‚Äî‚Ääonce set up, you don‚Äôt have to think about these.</p>

<p>This class should be a Singleton. I use the <a href="https://insert-koin.io/">Koin dependency injection</a> framework to enforce this, and inject it whenever I am accessing AWS resources.</p>

<p>Now, let‚Äôs go back to the specific cases of authentication. When you wrap an entire section of your app, you will redirect to an <code class="highlighter-rouge">AuthenticatorActivity</code> that you create that initializes the authentication screen, then moves on to the next screen when successful:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="kd">class</span> <span class="nc">AuthenticatorActivity</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">service</span><span class="p">:</span> <span class="n">AWSService</span><span class="p">)</span> <span class="p">:</span> <span class="nc">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="nv">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_authenticator</span><span class="p">)</span>

        <span class="c1">// Set up the callbacks to handle the authentication response</span>
        <span class="n">service</span><span class="p">.</span><span class="n">identityManager</span><span class="p">.</span><span class="n">login</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">DefaultSignInResultHandler</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onSuccess</span><span class="p">(</span><span class="nv">activity</span><span class="p">:</span> <span class="nc">Activity</span><span class="p">,</span> <span class="nv">identityProvider</span><span class="p">:</span> <span class="nc">IdentityProvider</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">Toast</span><span class="p">.</span><span class="n">makeText</span><span class="p">(</span><span class="k">this</span><span class="nd">@AuthenticatorActivity</span><span class="p">,</span>
                        <span class="n">String</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="s">"Logged in as %s"</span><span class="p">,</span> <span class="n">service</span><span class="p">.</span><span class="n">identityManager</span><span class="p">.</span><span class="n">getCachedUserID</span><span class="p">()),</span>
                        <span class="n">Toast</span><span class="p">.</span><span class="n">LENGTH_LONG</span><span class="p">).</span><span class="n">show</span><span class="p">()</span>
                <span class="c1">// Go to the main activity</span>
                <span class="kd">val</span> <span class="py">intent</span> <span class="p">=</span> <span class="n">Intent</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="n">MainActivity</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
                        <span class="p">.</span><span class="n">setFlags</span><span class="p">(</span><span class="n">Intent</span><span class="p">.</span><span class="n">FLAG_ACTIVITY_CLEAR_TOP</span><span class="p">)</span>
                <span class="n">activity</span><span class="p">.</span><span class="n">startActivity</span><span class="p">(</span><span class="n">intent</span><span class="p">)</span>
                <span class="n">activity</span><span class="p">.</span><span class="n">finish</span><span class="p">()</span>
            <span class="p">}</span>

            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCancel</span><span class="p">(</span><span class="nv">activity</span><span class="p">:</span> <span class="nc">Activity</span><span class="p">):</span> <span class="nc">Boolean</span> <span class="p">{</span>
                <span class="k">return</span> <span class="k">false</span>
            <span class="p">}</span>
        <span class="p">})</span>

        <span class="c1">// Start the authentication UI</span>
        <span class="kd">val</span> <span class="py">config</span> <span class="p">=</span> <span class="n">AuthUIConfiguration</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
                <span class="p">.</span><span class="n">userPools</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
                <span class="p">.</span><span class="n">build</span><span class="p">()</span>
        <span class="n">SignInActivity</span><span class="p">.</span><span class="n">startSignInActivity</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
        <span class="k">this</span><span class="nd">@AuthenticatorActivity</span><span class="p">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>This <code class="highlighter-rouge">AuthenticatorActivity</code> is just passing control to the provided <code class="highlighter-rouge">SignInActivity</code> (which is part of the AWS Mobile SDK). When it returns, the <code class="highlighter-rouge">onSuccess</code> callback is called. This then transfers control to the next activity (in this case, <code class="highlighter-rouge">MainActivity</code>). Now all you have to do is to switch to the <code class="highlighter-rouge">AuthenticatorActivity</code> whenever you want. In most tutorials, this becomes the entry point of the app.</p>

<p>What about setting up a sign-in link within a navigation drawer? You can use this same logic. First up, add a navigation drawer to the <code class="highlighter-rouge">MainActivity</code>. In the navigation drawer menu, add a link for the sign-in:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="c">&lt;!-- activity_nav_drawer.xml --&gt;</span>
<span class="cp">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="nt">&lt;menu</span> <span class="na">xmlns:android=</span><span class="s">"http://schemas.android.com/apk/res/android"</span>
    <span class="na">xmlns:tools=</span><span class="s">"http://schemas.android.com/tools"</span>
    <span class="na">tools:showIn=</span><span class="s">"navigation_view"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;group</span> <span class="na">android:checkableBehavior=</span><span class="s">"single"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;item</span>
            <span class="na">android:id=</span><span class="s">"@+id/main_drawer_login"</span>
            <span class="na">android:icon=</span><span class="s">"@drawable/ic_password_black_24dp"</span>
            <span class="na">android:title=</span><span class="s">"@string/nav_signin"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/group&gt;</span>
<span class="nt">&lt;/menu&gt;</span></code></pre></figure>

<p>I want the link to switch between Sign In and Sign Out depending on the authentication state. Start by putting some code in the <code class="highlighter-rouge">onCreate()</code> method of the <code class="highlighter-rouge">MainActivity</code>:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="nv">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
    <span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_main</span><span class="p">)</span>

    <span class="cm">/* Configure the action bar */</span>
    <span class="n">setSupportActionBar</span><span class="p">(</span><span class="n">main_toolbar</span><span class="p">)</span>

    <span class="cm">/* Configure the navigation drawer */</span>
    <span class="kd">val</span> <span class="py">toggle</span> <span class="p">=</span> <span class="n">ActionBarDrawerToggle</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">drawer_layout</span><span class="p">,</span> <span class="n">main_toolbar</span><span class="p">,</span> <span class="n">R</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">navigation_drawer_open</span><span class="p">,</span> <span class="n">R</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">navigation_drawer_close</span><span class="p">)</span>
    <span class="n">drawer_layout</span><span class="p">.</span><span class="n">addDrawerListener</span><span class="p">(</span><span class="n">toggle</span><span class="p">)</span>
    <span class="n">toggle</span><span class="p">.</span><span class="n">syncState</span><span class="p">()</span>
    <span class="n">nav_view</span><span class="p">.</span><span class="n">setNavigationItemSelectedListener</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>

    <span class="cm">/* Resume the authentication session, if available */</span>
    <span class="n">service</span><span class="p">.</span><span class="n">identityManager</span><span class="p">.</span><span class="n">resumeSession</span><span class="p">(</span><span class="k">this</span><span class="nd">@MainActivity</span><span class="p">)</span> <span class="p">{</span> <span class="n">result</span> <span class="p">-&gt;</span>
        <span class="n">updateNavigationDrawer</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">isUserSignedIn</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Most of this is just the normal code for implementing a navigation drawer. In fact, I got it from the template activity that includes the navigation drawer.  However, the final piece is important. The AWS Mobile SDK stores the authentication token until its expiry. The <code class="highlighter-rouge">resumeSession()</code> method will load that authentication token if available. We then update the navigation drawer according to the auth state:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="cm">/**</span><span class="err">
</span><span class="cm">  * Update the menu for signed in/out status</span><span class="err">
</span><span class="cm">  */</span>
<span class="k">private</span> <span class="k">fun</span> <span class="nf">updateNavigationDrawer</span><span class="p">(</span><span class="nv">isSignedIn</span><span class="p">:</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">loginItem</span> <span class="p">=</span> <span class="n">nav_view</span><span class="p">.</span><span class="n">menu</span><span class="p">.</span><span class="n">findItem</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">main_drawer_login</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(!</span><span class="n">isSignedIn</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">loginItem</span><span class="p">.</span><span class="n">title</span> <span class="p">=</span> <span class="n">resources</span><span class="p">.</span><span class="n">getString</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">nav_signin</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">loginItem</span><span class="p">.</span><span class="n">title</span> <span class="p">=</span> <span class="n">resources</span><span class="p">.</span><span class="n">getString</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">nav_signout</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The final piece we need to do is to listen for the click on the Sign In or Sign Out link. This is done in the <code class="highlighter-rouge">onNavigationItemSelected()</code> method:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="k">override</span> <span class="k">fun</span> <span class="nf">onNavigationItemSelected</span><span class="p">(</span><span class="nv">item</span><span class="p">:</span> <span class="nc">MenuItem</span><span class="p">):</span> <span class="nc">Boolean</span> <span class="p">{</span>
    <span class="k">when</span> <span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">itemId</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">main_drawer_login</span> <span class="p">-&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">service</span><span class="p">.</span><span class="n">identityManager</span><span class="p">.</span><span class="n">isUserSignedIn</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">service</span><span class="p">.</span><span class="n">identityManager</span><span class="p">.</span><span class="n">signOut</span><span class="p">()</span>
                <span class="n">updateNavigationDrawer</span><span class="p">(</span><span class="n">service</span><span class="p">.</span><span class="n">identityManager</span><span class="p">.</span><span class="n">isUserSignedIn</span><span class="p">)</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">service</span><span class="p">.</span><span class="n">identityManager</span><span class="p">.</span><span class="n">login</span><span class="p">(</span><span class="k">this</span><span class="nd">@MainActivity</span><span class="p">,</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">DefaultSignInResultHandler</span><span class="p">()</span> <span class="p">{</span>
                    <span class="cm">/**</span><span class="err">
</span><span class="cm">                      * Called when the user has obtained an identity by signing in with a provider.</span><span class="err">
</span><span class="cm">                      *</span><span class="err">
</span><span class="cm">                      * @param callingActivity the calling activity that should be finished.</span><span class="err">
</span><span class="cm">                      * @param provider the provider or null if succeeded with an unauthenticated identity.</span><span class="err">
</span><span class="cm">                      */</span>
                    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onSuccess</span><span class="p">(</span><span class="nv">callingActivity</span><span class="p">:</span> <span class="nc">Activity</span><span class="p">?,</span> <span class="nv">provider</span><span class="p">:</span> <span class="nc">IdentityProvider</span><span class="p">?)</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">service</span><span class="p">.</span><span class="n">identityManager</span><span class="p">.</span><span class="n">isUserSignedIn</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">analyticsService</span><span class="p">.</span><span class="n">recordSuccessfulLogin</span><span class="p">(</span><span class="n">service</span><span class="p">.</span><span class="n">identityManager</span><span class="p">.</span><span class="n">cachedUserID</span><span class="p">)</span>
                            <span class="n">updateNavigationDrawer</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="n">analyticsService</span><span class="p">.</span><span class="n">recordFailedLogin</span><span class="p">()</span>
                            <span class="n">updateNavigationDrawer</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
                        <span class="p">}</span>
                    <span class="p">}</span>

                    <span class="cm">/**</span><span class="err">
</span><span class="cm">                      * User pressed back from the sign-in Activity.</span><span class="err">
</span><span class="cm">                      *</span><span class="err">
</span><span class="cm">                      * @return true if the activity should be finished, otherwise false.</span><span class="err">
</span><span class="cm">                      */</span>
                    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCancel</span><span class="p">(</span><span class="nv">callingActivity</span><span class="p">:</span> <span class="nc">Activity</span><span class="p">?):</span> <span class="nc">Boolean</span> <span class="p">=</span> <span class="k">true</span>
                <span class="p">})</span>

                <span class="kd">val</span> <span class="py">authConfig</span> <span class="p">=</span> <span class="n">AuthUIConfiguration</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
                        <span class="p">.</span><span class="n">userPools</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
                        <span class="p">.</span><span class="n">build</span><span class="p">()</span>
                <span class="n">SignInActivity</span><span class="p">.</span><span class="n">startSignInActivity</span><span class="p">(</span><span class="k">this</span><span class="nd">@MainActivity</span><span class="p">,</span> <span class="n">authConfig</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">drawer_layout</span><span class="p">.</span><span class="n">closeDrawer</span><span class="p">(</span><span class="n">GravityCompat</span><span class="p">.</span><span class="n">START</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">true</span>
<span class="p">}</span></code></pre></figure>

<p>If the user is logged in, they are signed out. If they are already logged out, we run the exact same code that we used in the <code class="highlighter-rouge">AuthenticatorActivity</code>. However, instead of switching to a new activity, we are just updating the navigation drawer. If you need to refresh data or update the UI in some other way, this is the place to do it.</p>

<h2 id="cancelling-the-authentication">Cancelling the authentication</h2>

<p>If you have an optional authentication step, you are likely to want to enable cancellation. You can do this by adjusting the <code class="highlighter-rouge">authConfig</code> object:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="kd">val</span> <span class="py">authConfig</span> <span class="p">=</span> <span class="n">AuthUIConfiguration</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
    <span class="p">.</span><span class="n">userPools</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
    <span class="p">.</span><span class="n">canCancel</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
    <span class="p">.</span><span class="n">build</span><span class="p">()</span></code></pre></figure>

<p>This add a normal cancellation process (click on the back button or the close icon on screen). In this case, the <code class="highlighter-rouge">onCancel()</code> method is called instead of <code class="highlighter-rouge">onSuccess()</code>. This allows you to add analytics about authentication cancellations.</p>

<h2 id="basic-customization">Basic customization</h2>

<p>You can change several things about the authentication UI by altering the <code class="highlighter-rouge">authConfig</code> object:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="kd">val</span> <span class="py">authConfig</span> <span class="p">=</span> <span class="n">AuthUIConfiguration</span><span class="p">.</span><span class="n">Builder</span><span class="p">()</span>
        <span class="p">.</span><span class="n">userPools</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
        <span class="p">.</span><span class="n">canCancel</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
        <span class="p">.</span><span class="n">backgroundColor</span><span class="p">(</span><span class="n">Color</span><span class="p">.</span><span class="n">BLUE</span><span class="p">)</span>
        <span class="p">.</span><span class="n">isBackgroundColorFullScreen</span><span class="p">(</span><span class="k">true</span><span class="p">)</span>
        <span class="p">.</span><span class="n">logoResId</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">drawable</span><span class="p">.</span><span class="n">app_logo</span><span class="p">)</span>
        <span class="p">.</span><span class="n">fontFamily</span><span class="p">(</span><span class="s">"sans-serif-medium"</span><span class="p">)</span>
        <span class="p">.</span><span class="n">build</span><span class="p">()</span></code></pre></figure>

<p>The background color, logo and font-family can be changed. If you are changing the font-family, it must a built-in font. You can‚Äôt use a custom font.</p>

<p>If you want to do any customization of the screens beyond these simple changes, then a fully customized UI is needed. That is the topic for my next article.</p>

<!-- AWS Links -->

<!-- Consoles -->

<!-- My Links -->

:ET