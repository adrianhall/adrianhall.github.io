I"âQ<p>Iâ€™ve become a big fan of <a href="https://kotlinlang.org/">Kotlin development</a> for my Android apps. I also think that analytics should be integrated into every single app I write. Iâ€™ve covered integrating Amazon Pinpoint before via AWS Mobile Hub. Recently, <a href="https://aws-amplify.github.io?utm_source=da&amp;utm_medium=blog&amp;utm_campaign=adrianha">AWS Amplify</a> announced an updated CLI that provides support for native applications and bypasses the need to use the AWS web console for creating resources. Naturally, <a href="/android/2018/08/27/native-development-with-aws-amplify/">I wanted to try it out</a>. Integrating analytics is now really easy. Here is how I do it:</p>

<h2 id="start-local">Start Local</h2>

<p>You donâ€™t need to create any services in the cloud to get started with analytics. I start by defining an interface for recording analytics events:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="kd">interface</span> <span class="nc">AnalyticsService</span> <span class="p">{</span>
  <span class="k">fun</span> <span class="nf">recordEvent</span><span class="p">(</span><span class="nv">eventName</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span><span class="nc">String</span><span class="p">&gt;?</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">metrics</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span><span class="nc">Double</span><span class="p">&gt;?</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>Where there is an interface, there is also a concrete implementation:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="kd">class</span> <span class="nc">LocalAnalyticsService</span> <span class="p">:</span> <span class="n">AnalyticsService</span> <span class="p">{</span>
  <span class="k">override</span> <span class="k">fun</span> <span class="nf">recordEvent</span><span class="p">(</span><span class="nv">eventName</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span><span class="nc">String</span><span class="p">&gt;?,</span> <span class="nv">metrics</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span><span class="nc">Double</span><span class="p">&gt;?)</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">event</span> <span class="p">=</span> <span class="n">StringBuilder</span><span class="p">(</span><span class="s">""</span><span class="p">)</span>
    <span class="n">attributes</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">in</span> <span class="n">it</span><span class="p">)</span> <span class="p">{</span> <span class="n">event</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">", $k=\"$v\""</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">metrics</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">in</span> <span class="n">it</span><span class="p">)</span> <span class="p">{</span> <span class="n">event</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">", $k=${String.format("</span><span class="p">%.</span><span class="m">2f</span><span class="s">",v)}"</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="n">isNotEmpty</span><span class="p">())</span>
      <span class="n">event</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="sc">':'</span>
    <span class="n">Log</span><span class="p">.</span><span class="n">v</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">"recordEvent($eventName)$event"</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Before I can use it, I have to instantiate a version of it. This should be a singleton, since many cloud services need a singular context to handle authentication and to minimize the number of outbound connections that are created. This isnâ€™t using a cloud service yet, but I am going to do that later. I use <a href="https://insert-koin.io/">Koin dependency injection</a> throughout my app for dealing with this, but you can use a regular singleton pattern, <a href="https://google.github.io/dagger/">Dagger2</a>, <a href="http://kodein.org/Kodein-DI/">Kodein</a>, or any other DI framework. In my case, I edit my application entry point to add the analytics service to the DI module:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="k">private</span> <span class="kd">val</span> <span class="py">servicesModule</span> <span class="p">:</span> <span class="n">Module</span> <span class="p">=</span> <span class="n">applicationContext</span> <span class="p">{</span>
  <span class="n">bean</span> <span class="p">{</span> <span class="n">LocalAnalyticsService</span><span class="p">()</span> <span class="k">as</span> <span class="n">AnalyticsService</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>To use it, I edit my activities to inject the analytics service:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="k">private</span> <span class="kd">val</span> <span class="py">analyticsService</span> <span class="p">:</span> <span class="n">AnalyticsService</span> <span class="k">by</span> <span class="n">inject</span><span class="p">()</span></code></pre></figure>

<p>I then liberally sprinkle my code with <code class="highlighter-rouge">recordEvent()</code> calls. In this case, they become debug log statements that I can monitor while I am developing the app.</p>

<h2 id="build-an-analytics-service-with-amazon-pinpoint">Build an Analytics Service with Amazon Pinpoint</h2>

<p>Building a backend service for your Android or iOS app is easy with the <a href="https://aws-amplify.github.io?utm_source=da&amp;utm_medium=blog&amp;utm_campaign=adrianha">AWS Amplify</a> CLI.  First, <a href="https://aws-amplify.github.io/media/get_started?utm_source=da&amp;utm_medium=blog&amp;utm_campaign=adrianha">install and configure the AWS Amplify CLI</a>.   There are detailed instructions plus a video on the AWS Amplify website.</p>

<p>Open a terminal and change directory to your project directory (which is the one with top-level <code class="highlighter-rouge">build.gradle</code> file). First, initialize the project:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">amplify init</code></pre></figure>

<p>Youâ€™ll be guided through the process, which includes naming the project, confirming that you are developing an Android project and choosing appropriate credentials for deploying resources to AWS. This command will create an amplify directory to store the details of the backend. Now, letâ€™s add an Amazon Pinpoint resource for storing analytics:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">amplify add analytics</code></pre></figure>

<p>You can press enter to progress through the process. All the defaults are good for this app. Finally, letâ€™s deploy the resources:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">amplify push</code></pre></figure>

<p>Youâ€™ll be asked to confirm the deployment and then the resources are created. More importantly, this will create the <code class="highlighter-rouge">awsconfiguration.json</code> file in the <code class="highlighter-rouge">res/raw</code> directory. This JSON file contains a description of the resources that you can access via your app. Without this file, you would have to log into the AWS console and take a look at each resource, copying the access information from the console into a constants file, and then use those constants to initialize the SDK. This is a major friction point for developing the app.</p>

<p>With the AWS Amplify CLI, the <code class="highlighter-rouge">awsconfiguration.json</code> is maintained in the proper location for you.</p>

<h2 id="add-the-aws-sdk-to-your-project">Add the AWS SDK to your project</h2>

<p>The AWS SDK contains all the code necessary to connect to AWS cloud resources, including <a href="https://aws.amazon.com/pinpoint">Amazon Pinpoint</a>. You can easily download the libraries using gradle. I add the following to my dependencies:</p>

<figure class="highlight"><pre><code class="language-gradle" data-lang="gradle"><span class="k">dependencies</span> <span class="o">{</span>
  <span class="c1">// Other dependencies here</span>
  <span class="n">implementation</span> <span class="s1">'com.amazonaws:aws-android-sdk-pinpoint:2.6.29'</span>
  <span class="n">implementation</span> <span class="o">(</span><span class="s1">'com.amazonaws:aws-android-sdk-mobile-client:2.6.29@aar'</span><span class="o">)</span> <span class="o">{</span> <span class="n">transitive</span> <span class="o">=</span> <span class="kc">true</span> <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>You will also need to add the following permissions to your <code class="highlighter-rouge">AndroidManifest.xml</code> file:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.INTERNET"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;uses-permission</span> <span class="na">android:name=</span><span class="s">"android.permission.ACCESS_NETWORK_STATE"</span><span class="nt">/&gt;</span></code></pre></figure>

<h2 id="create-a-new-awsanalyticsservice-class">Create a new AWSAnalyticsService class</h2>

<p>We can now replace the <code class="highlighter-rouge">LocalAnalyticsService</code> with one that talks to Amazon Pinpoint:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="k">import</span> <span class="nn">android.content.Context</span>
<span class="k">import</span> <span class="nn">com.amazonaws.mobile.auth.core.IdentityManager</span>
<span class="k">import</span> <span class="nn">com.amazonaws.mobile.config.AWSConfiguration</span>
<span class="k">import</span> <span class="nn">com.amazonaws.mobile.samples.picturefeed.services.AnalyticsService</span>
<span class="k">import</span> <span class="nn">com.amazonaws.mobileconnectors.pinpoint.PinpointConfiguration</span>
<span class="k">import</span> <span class="nn">com.amazonaws.mobileconnectors.pinpoint.PinpointManager</span>

<span class="kd">class</span> <span class="nc">AWSAnalyticsService</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="nc">Context</span><span class="p">):</span> <span class="nc">AnalyticsService</span> <span class="p">{</span>
    <span class="k">private</span> <span class="kd">var</span> <span class="py">manager</span><span class="p">:</span> <span class="n">PinpointManager</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="n">init</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">awsConfiguration</span> <span class="p">=</span> <span class="n">AWSConfiguration</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">identityManager</span> <span class="p">=</span> <span class="n">IdentityManager</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">awsConfiguration</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">config</span> <span class="p">=</span> <span class="n">PinpointConfiguration</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">identityManager</span><span class="p">.</span><span class="n">credentialsProvider</span><span class="p">,</span> <span class="n">awsConfiguration</span><span class="p">)</span>
        <span class="n">manager</span> <span class="p">=</span> <span class="n">PinpointManager</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">manager</span><span class="o">?.</span><span class="n">sessionClient</span><span class="p">.</span><span class="n">startSession</span><span class="p">()</span>
        <span class="n">manager</span><span class="o">?.</span><span class="n">analyticsClient</span><span class="p">.</span><span class="n">submitEvents</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="cm">/**</span><span class="err">
</span><span class="cm">     * Record a custom event into the analytics stream</span><span class="err">
</span><span class="cm">     *</span><span class="err">
</span><span class="cm">     * @param name the custom event name</span><span class="err">
</span><span class="cm">     * @param [attributes] a list of key-value pairs for recording string attributes</span><span class="err">
</span><span class="cm">     * @param [metrics] a list of key-value pairs for recording numeric metrics</span><span class="err">
</span><span class="cm">     */</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">recordEvent</span><span class="p">(</span><span class="nv">name</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="nv">attributes</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;?,</span> <span class="nv">metrics</span><span class="p">:</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">Double</span><span class="p">&gt;?)</span> <span class="p">{</span>
        <span class="n">manager</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">event</span> <span class="p">=</span> <span class="n">it</span><span class="p">.</span><span class="n">analyticsClient</span><span class="p">.</span><span class="n">createEvent</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">for</span> <span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">in</span> <span class="n">attributes</span><span class="p">.</span><span class="n">orEmpty</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">event</span><span class="p">.</span><span class="n">addAttribute</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="p">((</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="k">in</span> <span class="n">metrics</span><span class="p">.</span><span class="n">orEmpty</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">event</span><span class="p">.</span><span class="n">addMetric</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">it</span><span class="p">.</span><span class="n">analyticsClient</span><span class="p">.</span><span class="n">recordEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">it</span><span class="p">.</span><span class="n">analyticsClient</span><span class="p">.</span><span class="n">submitEvents</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The <code class="highlighter-rouge">AWSConfiguration</code> and <code class="highlighter-rouge">IdentityManager</code> objects should be shared among all AWS service libraries. If you are doing more than analytics, then you should probably abstract those into their own class that is injected into this class. I automatically record a start-session event so I can always get usage analytics.</p>

<p>You can easily inject this using Koin:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="k">private</span> <span class="kd">val</span> <span class="py">servicesModule</span> <span class="p">:</span> <span class="n">Module</span> <span class="p">=</span> <span class="n">applicationContext</span> <span class="p">{</span>
  <span class="n">bean</span> <span class="p">{</span> <span class="n">AWSAnalyticsService</span><span class="p">(</span><span class="k">get</span><span class="p">())</span> <span class="k">as</span> <span class="n">AnalyticsService</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Here, the <code class="highlighter-rouge">get()</code> will inject the application context for me.</p>

<h2 id="check-out-the-analytics">Check out the analytics</h2>

<p>Once you run your app and do some stuff to generate appropriate analytics traffic, you can open up the Pinpoint console:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">amplify analytics console</code></pre></figure>

<p>You will probably be asked to log in to the consoleâ€Šâ€”â€Šjust use your regular AWS crednetials. You will be placed directly in the analytics tab and can start exploring the graphs that are provided out of the box.</p>

<h2 id="recording-other-events">Recording other events</h2>

<p>Amazon Pinpoint also allows you to <a href="https://aws.github.io/aws-sdk-android/docs/reference//index.html?com/amazonaws/mobileconnectors/pinpoint/analytics/monetization/MonetizationEventBuilder.html">record revenue events</a>. There are several versionsâ€Šâ€”â€Šfor Google Play, Amazon and custom events. You can also make your own version up. This is good if you are doing in-app purchases. Just add a method to the interface and concrete implementation. You can then get a live update (on the Pinpoint console) of how much money you made today (or last week, month or year).</p>

<p>There are specific events that you can record for authentication events:</p>

<ul>
  <li><code class="highlighter-rouge">_userauth.sign_in</code></li>
  <li><code class="highlighter-rouge">_userauth.sign_up</code></li>
  <li><code class="highlighter-rouge">_userauth.authfail</code></li>
</ul>

<p>This allows you to record some information about authentication events for both Amazon Cognito and 3rd party authentication libraries using just the <code class="highlighter-rouge">recordEvent()</code> method I presented here. Iâ€™ll be doing <a href="/android/2018/09/18/auth-with-aws-amplify-1/">a series of in-depth authentication articles with AWS Amplify</a> later on, so stay tuned for that.</p>

<p>My next article will show off how to record user-specific information (for example, tagging with a username or location) and user-provided information (for example, topics of interest) so that we can produce segments of users, all with the aim of doing marketing campaigns and communicating with the user base. Until that point, start getting into cloud backends with <a href="https://aws-amplify.github.io?utm_source=da&amp;utm_medium=blog&amp;utm_campaign=adrianha">AWS Amplify</a>.</p>

<!-- AWS Links -->

<!-- Consoles -->

<!-- My Links -->

:ET