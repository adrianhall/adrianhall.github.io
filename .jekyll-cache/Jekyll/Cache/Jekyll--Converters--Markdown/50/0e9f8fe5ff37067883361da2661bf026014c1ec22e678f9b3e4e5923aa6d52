I"gë<p>In <a href="/android/tailwind%20photos/2019/08/15/tailwind-photos-1/">my last post on Tailwind Photos</a>, I set up the splash screen and the buttons I want to use for signing in to the app - social media buttons for Facebook, Google, Microsoft, and Twitter.  In this article, I‚Äôm going to go through the process of authenticating Facebook.</p>

<h2 id="the-facebook-side-of-things">The Facebook side of things</h2>

<p>All social media companies have their own methods for setting up authentication, and Facebook is no different.  The instructions I have here are correct as of writing, but you should realize the aim of these instructions:</p>

<ul>
  <li>Register a native mobile app for authentication.</li>
  <li>Get the codes needed by the SDK to configure Facebook Auth.</li>
</ul>

<p>These may change in the future.  Let‚Äôs get started!</p>

<ol>
  <li>Log on to <a href="https://developers.facebook.com">developers.facebook.com</a></li>
  <li>If necessary, agree to any terms and conditions to become a Facebook developer.</li>
  <li>Select <strong>My Apps</strong> &gt; <strong>Create App</strong> in the top-right corner.</li>
  <li>Enter a display name and your contact email.  I‚Äôm using <code class="highlighter-rouge">Tailwind Photos</code> for my display name.</li>
  <li>Click <strong>Create App ID</strong>.</li>
  <li>Click <strong>Integrate Facebook Login</strong> in the scenari selector, then click <strong>Confirm</strong>.</li>
  <li>Click <strong>Facebook Login</strong> &gt; <strong>Quickstart</strong>.</li>
  <li>Click <strong>Android</strong>.</li>
</ol>

<p>What you will get next is a step-by-step process for integrating the Facebook Button for Android, including downloading the SDK, integrating it into your app, and generating all the keys needed.  We‚Äôll go through the same process, but in a different order.  That‚Äôs mostly because I like to separate the ‚Äúwhat to do on the website‚Äù stuff from ‚Äúwhat to do in code‚Äù.</p>

<ul>
  <li>Download the Facebook SDK for Android: Click <strong>Next</strong> - we don‚Äôt need to do this.</li>
  <li>Import the Facebook SDK: Click <strong>Next</strong> - we‚Äôll do this during the code section.</li>
  <li>Tell Us about Your Android Project:
    <ul>
      <li>Enter the package name (mine is <code class="highlighter-rouge">com.tailwind.app.photos</code>).</li>
      <li>Enter the deep-linking activity (I‚Äôm using <code class="highlighter-rouge">com.tailwind.app.photos.activities.AuthenticatorActivity</code>).</li>
      <li>Click <strong>Save</strong></li>
      <li>Click <strong>Use this package name</strong> (since your package is not on Google Play yet).</li>
      <li>Click <strong>Continue</strong>.</li>
    </ul>
  </li>
  <li>Generate a development key hash (ignore the requirement for a release key hash).</li>
</ul>

<p>Hmm - how can we do this from Android Studio?  The easiest way is to add some code temporarily to the <code class="highlighter-rouge">SplashActivity</code> class:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="kd">class</span> <span class="nc">SplashActivity</span> <span class="p">:</span> <span class="n">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="nv">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
		<span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>

		<span class="n">printhashkey</span><span class="p">()</span>

		<span class="n">startActivity</span><span class="p">(</span><span class="n">Intent</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">AuthenticatorActivity</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">))</span>
		<span class="n">finish</span><span class="p">()</span>
	<span class="p">}</span>

	<span class="k">fun</span> <span class="nf">printhashkey</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">try</span> <span class="p">{</span>
			<span class="kd">val</span> <span class="py">info</span> <span class="p">=</span> <span class="n">packageManager</span><span class="p">.</span><span class="n">getPackageInfo</span><span class="p">(</span><span class="s">"com.tailwind.app.photos"</span><span class="p">,</span> <span class="n">PackageManager</span><span class="p">.</span><span class="n">GET_SIGNATURES</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">signature</span> <span class="k">in</span> <span class="n">info</span><span class="p">.</span><span class="n">signatures</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">val</span> <span class="py">md</span> <span class="p">=</span> <span class="n">MessageDigest</span><span class="p">.</span><span class="n">getInstance</span><span class="p">(</span><span class="s">"SHA"</span><span class="p">)</span>
				<span class="n">md</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">signature</span><span class="p">.</span><span class="n">toByteArray</span><span class="p">())</span>
				<span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="s">"KeyHash:"</span><span class="p">,</span> <span class="n">Base64</span><span class="p">.</span><span class="n">encodeToString</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">digest</span><span class="p">(),</span> <span class="n">Base64</span><span class="p">.</span><span class="n">DEFAULT</span><span class="p">))</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nv">e</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">()</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<blockquote>
  <p><strong>DO NOT</strong> leave this code in your application.  It‚Äôs a deprecated security risk.  There is also a command line version (which the instructions provide) if you never want to include temporary code in your app.  Always get the release key hash using the command line tool.</p>
</blockquote>

<p>Run your app and watch the LogCat window:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">2019-08-15 11:35:45.656 2990-2990/? I/InstantRun: starting instant run server: is main process
2019-08-15 11:35:45.890 2990-2990/? D/KeyHash:: HXObbXXX8wVtfDHiT6jm14bCCC0=
2019-08-15 11:35:46.520 2990-2990/? W/wind.app.photo: Accessing hidden method Landroid/view/View;-&gt;computeFitSystemWindows(Landroid/graphics/Rect;Landroid/graphics/Rect;)Z (light greylist, reflection)
2019-08-15 11:35:46.520 2990-2990/? W/wind.app.photo: Accessing hidden method Landroid/view/ViewGroup;-&gt;makeOptionalFitsSystemWindows()V (light greylist, reflection)
2019-08-15 11:35:46.883 2990-2990/com.tailwind.app.photos W/wind.app.photo: Accessing hidden method Landroid/graphics/FontFamily;-&gt;&lt;init&gt;()V (light greylist, reflection)</code></pre></figure>

<p>The second line contains the development key hash.  Copy it into the box provided, then click <strong>Save</strong> followed by <strong>Continue</strong>.  Don‚Äôt forget to remove this code from your application.</p>

<blockquote>
  <p>You need to add the key hashes from every single machine you use for developing this app.  To add further key hashes (including an eventual release key hash):</p>
  <ul>
    <li>Go back to the <a href="https://developers.facebook.com">Facebook Developers page</a>.</li>
    <li>Click <strong>My Apps</strong> &gt; <em>Your App Name</em></li>
    <li>Click <strong>Settings</strong> &gt; <strong>Basic</strong> in the left hand nav (right below the dashboard).</li>
    <li>Scroll down to the bottom of the page.</li>
    <li>Copy the hash into the <strong>Key Hashes</strong> field (making sure you don‚Äôt delete the ones that are already there).</li>
    <li>Click <strong>Save Changes</strong> at the very bottom of the page.</li>
  </ul>
</blockquote>

<ul>
  <li>Enable Single Sign On for Your App: I generally turn this on because I‚Äôm bound to use it eventually.
    <ul>
      <li>Click the switch icon to turn it to <strong>Yes</strong>.</li>
      <li>Click <strong>Save</strong>, then <strong>Next</strong>.</li>
    </ul>
  </li>
</ul>

<p>In the next step, your <strong>Facebook App ID</strong> and <strong>Login Protocol Scheme</strong> are shown.</p>

<h2 id="the-app-side-of-things">The App side of things</h2>

<p>You‚Äôre basically done with the Facebook side of things.  Everything else is done in the app, so you could just click <strong>Next</strong> a bunch of times.  However, the SDK does change from time to time, so you can also follow the instructions.</p>

<h3 id="add-the-facebook-sdk-to-your-library">Add the Facebook SDK to your library</h3>

<p>This step was #2 in the list! Edit the project-level <code class="highlighter-rouge">build.gradle</code>:</p>

<figure class="highlight"><pre><code class="language-gradle" data-lang="gradle"><span class="k">buildscript</span> <span class="o">{</span>
	<span class="n">ext</span><span class="o">.</span><span class="na">kotlin_version</span> <span class="o">=</span> <span class="s1">'1.3.41'</span>
	<span class="k">repositories</span> <span class="o">{</span>
		<span class="n">google</span><span class="o">()</span>
		<span class="n">jcenter</span><span class="o">()</span>
		<span class="n">mavenCentral</span><span class="o">()</span>

	<span class="o">}</span>
	<span class="k">dependencies</span> <span class="o">{</span>
		<span class="n">classpath</span> <span class="s1">'com.android.tools.build:gradle:3.4.2'</span>
		<span class="n">classpath</span> <span class="s2">"org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="k">allprojects</span> <span class="o">{</span>
	<span class="k">repositories</span> <span class="o">{</span>
		<span class="n">google</span><span class="o">()</span>
		<span class="n">jcenter</span><span class="o">()</span>
		<span class="n">mavenCentral</span><span class="o">()</span>
	<span class="o">}</span>
<span class="o">}</span>

<span class="n">task</span> <span class="nf">clean</span><span class="o">(</span><span class="nl">type:</span> <span class="n">Delete</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">delete</span> <span class="n">rootProject</span><span class="o">.</span><span class="na">buildDir</span>
<span class="o">}</span></code></pre></figure>

<p>Don‚Äôt click <strong>Sync now</strong> just yet.  We need to add dependencies first.  Next, edit the module-level <code class="highlighter-rouge">build.gradle</code> file.  Add the Facebook SDK to the <code class="highlighter-rouge">dependencies</code> section:</p>

<figure class="highlight"><pre><code class="language-gradle" data-lang="gradle"><span class="k">dependencies</span> <span class="o">{</span>
	<span class="n">implementation</span> <span class="nf">fileTree</span><span class="o">(</span><span class="nl">dir:</span> <span class="s1">'libs'</span><span class="o">,</span> <span class="nl">include:</span> <span class="o">[</span><span class="s1">'*.jar'</span><span class="o">])</span>
	<span class="n">implementation</span> <span class="s2">"org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"</span>
	<span class="n">implementation</span> <span class="s1">'androidx.appcompat:appcompat:1.0.2'</span>
	<span class="n">implementation</span> <span class="s1">'androidx.core:core-ktx:1.0.2'</span>
	<span class="n">implementation</span> <span class="s1">'androidx.constraintlayout:constraintlayout:1.1.3'</span>
	<span class="n">implementation</span> <span class="s1">'androidx.cardview:cardview:1.0.0'</span>
	<span class="n">implementation</span> <span class="s1">'com.facebook.android:facebook-android-sdk:[5,6)'</span>
<span class="o">}</span></code></pre></figure>

<p>Now you can use that <strong>Sync now</strong> button.</p>

<h3 id="edit-your-resources-and-manifest">Edit Your Resources and Manifest</h3>

<p>This piece is just just a copy-paste from the Facebook instructions, so I won‚Äôt bore you with the details.  You need to adjust <code class="highlighter-rouge">res/values/strings.xml</code> and the <code class="highlighter-rouge">AndroidManifest.xml</code> file.</p>

<h3 id="log-app-events">Log app events</h3>

<p>The Facebook Login code suggests you should log app activations.  I‚Äôm not sure my users want Facebook tracking them any more than they already do.  Since I‚Äôm doing ‚Äúmulti-authentication‚Äù, I‚Äôll want all the data in one place anyhow (that‚Äôs a topic for another day).</p>

<p>In addition, the code snippet that is shown suggests you should initialize the SDK.  You no longer need to do this, so this entire step can be skipped.</p>

<h3 id="add-the-facebook-login-button">Add the Facebook Login Button</h3>

<p>Well, we‚Äôve already done this, so let‚Äôs skip this.  If you came here to learn how to do this, you need to add an <code class="highlighter-rouge">ImageButton</code> to your layout.</p>

<h3 id="register-a-callback">Register a Callback</h3>

<p>Finally, let‚Äôs get to some code.  ‚ÄúRegister a Callback‚Äù really means ‚Äúwrite all the code that you need to write to make this work‚Äù.  If you follow the instructions from Facebook, then your authenticator activity looks like spagetti code, and no-one like spagetti code.  I prefer to isolate each authentication provider in its own manager class.  This allows me to do things behind the scenes.  The API surface of the manager is fairly simple:</p>

<ul>
  <li>Set up <code class="highlighter-rouge">onSuccess</code>, <code class="highlighter-rouge">onCancel</code>, and <code class="highlighter-rouge">onFailure</code> callbacks on initialization so that we can do async responses.</li>
  <li>Handle the <code class="highlighter-rouge">onActivityResult</code> response, since the SDK will go ‚Äúelsewhere‚Äù and then come back with a response.</li>
  <li>Initiate the sign-in from an <code class="highlighter-rouge">onClickHandler</code> for the button.</li>
</ul>

<p>Here is my <code class="highlighter-rouge">AuthenticatorActivity</code> class:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="kd">class</span> <span class="nc">AuthenticatorActivity</span> <span class="p">:</span> <span class="n">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">private</span> <span class="kd">val</span> <span class="py">fbManager</span> <span class="p">=</span> <span class="n">FacebookManager</span><span class="p">()</span>

	<span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="nv">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
		<span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
		<span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_authenticator</span><span class="p">)</span>

		<span class="cm">/* FACEBOOK AUTH INITIALIZATION */</span>
		<span class="n">fbManager</span>
			<span class="p">.</span><span class="n">onSuccess</span> <span class="p">{</span> <span class="n">user</span> <span class="p">-&gt;</span> <span class="n">moveToNextActivity</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
			<span class="p">.</span><span class="n">onFailure</span> <span class="p">{</span> <span class="n">error</span> <span class="p">-&gt;</span> <span class="n">displayErrorAlert</span><span class="p">(</span><span class="s">"Facebook"</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="p">}</span>
		<span class="n">facebook_login</span><span class="p">.</span><span class="n">setOnClickListener</span> <span class="p">{</span>
			<span class="n">fbManager</span><span class="p">.</span><span class="n">beginSignin</span><span class="p">(</span><span class="k">this</span><span class="nd">@AuthenticatorActivity</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">override</span> <span class="k">fun</span> <span class="nf">onActivityResult</span><span class="p">(</span><span class="nv">requestCode</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="nv">resultCode</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="nc">Intent</span><span class="p">?)</span> <span class="p">{</span>
		<span class="k">super</span><span class="p">.</span><span class="n">onActivityResult</span><span class="p">(</span><span class="n">requestCode</span><span class="p">,</span> <span class="n">resultCode</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
		<span class="n">fbManager</span><span class="p">.</span><span class="n">onActivityResult</span><span class="p">(</span><span class="n">requestCode</span><span class="p">,</span> <span class="n">resultCode</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">override</span> <span class="k">fun</span> <span class="nf">onResume</span><span class="p">()</span> <span class="p">{</span>
		<span class="k">super</span><span class="p">.</span><span class="n">onResume</span><span class="p">()</span>
		<span class="c1">// Do the same stuff in onResume() - it hasn't changed!</span>
	<span class="p">}</span>

	<span class="k">private</span> <span class="k">fun</span> <span class="nf">moveToNextActivity</span><span class="p">(</span><span class="nv">user</span><span class="p">:</span> <span class="nc">AuthenticatedUser</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">startActivity</span><span class="p">(</span><span class="n">Intent</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">MainActivity</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">))</span>
		<span class="n">finish</span><span class="p">()</span>
	<span class="p">}</span>

	<span class="k">private</span> <span class="k">fun</span> <span class="nf">displayErrorAlert</span><span class="p">(</span><span class="nv">provider</span><span class="p">:</span> <span class="nc">String</span><span class="p">,</span> <span class="nv">error</span><span class="p">:</span> <span class="nc">Exception</span><span class="p">?)</span> <span class="p">{</span>
		<span class="kd">val</span> <span class="py">alert</span> <span class="p">=</span> <span class="n">AlertDialog</span><span class="p">.</span><span class="n">Builder</span><span class="p">(</span><span class="k">this</span><span class="nd">@AuthenticatorActivity</span><span class="p">)</span>
			<span class="p">.</span><span class="n">setMessage</span><span class="p">(</span><span class="n">error</span><span class="o">?.</span><span class="n">message</span> <span class="o">?:</span> <span class="s">"Unknown Error"</span><span class="p">)</span>
			<span class="p">.</span><span class="n">setCancelable</span><span class="p">(</span><span class="k">false</span><span class="p">)</span>
			<span class="p">.</span><span class="n">setPositiveButton</span><span class="p">(</span><span class="s">"OK"</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="p">-&gt;</span> <span class="n">finish</span><span class="p">()</span> <span class="p">}</span>
			<span class="p">.</span><span class="n">create</span><span class="p">()</span>
		<span class="n">alert</span><span class="p">.</span><span class="n">setTitle</span><span class="p">(</span><span class="s">"$provider Login"</span><span class="p">)</span>
		<span class="n">alert</span><span class="p">.</span><span class="n">show</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>I can probably implement the same API surface for the other three providers.  In addition, I can likely take the <code class="highlighter-rouge">FacebookManager</code> with me to other applications.  Code re-use is a wonderful thing.  The <code class="highlighter-rouge">onSuccess</code> callback returns with an <code class="highlighter-rouge">AuthenticatedUser</code> object:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="k">package</span> <span class="nn">com.tailwind.app.photos.models</span>

<span class="k">enum</span> <span class="kd">class</span> <span class="nc">AuthenticationProvider</span> <span class="p">{</span>
	<span class="n">FACEBOOK</span><span class="p">,</span>
	<span class="n">GOOGLE</span><span class="p">,</span>
	<span class="n">MICROSOFT</span><span class="p">,</span>
	<span class="n">TWITTER</span>
<span class="p">}</span>

<span class="kd">data class</span> <span class="nc">AuthenticatedUser</span><span class="p">(</span>
	<span class="kd">val</span> <span class="py">accessToken</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="kd">val</span> <span class="py">authProvider</span><span class="p">:</span> <span class="n">AuthenticationProvider</span><span class="p">,</span>
	<span class="kd">val</span> <span class="py">fullname</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span>
	<span class="kd">val</span> <span class="py">emailAddress</span><span class="p">:</span> <span class="n">String</span><span class="p">)</span></code></pre></figure>

<p>In Kotlin parlance, the <code class="highlighter-rouge">AuthenticatedUser</code> is a common DTO.  Using a data class means I get several methods created for me.  I may decide to change it to a class since I don‚Äôt actually need the extra methods that are generated on a DTO.  However, the savings are not significant in doing that.</p>

<p>Back to the problem at hand - I now have to write the <code class="highlighter-rouge">FacebookManager</code> that conforms to the API surface I‚Äôve described.  Since the <code class="highlighter-rouge">FacebookManager</code> is only used once, I don‚Äôt need to use a singleton.  I‚Äôm interested in the <code class="highlighter-rouge">AuthenticatedUser</code> class since I‚Äôm abstracting away authentication provider.  If I were repeatedly using the access token and data returned by Facebook, I‚Äôd make this class a singleton so that the data is available across multiple activities.</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="k">typealias</span> <span class="n">OnSuccessCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">AuthenticatedUser</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
<span class="k">typealias</span> <span class="n">OnCancelCallback</span> <span class="p">=</span> <span class="p">()</span> <span class="p">-&gt;</span> <span class="n">Unit</span>
<span class="k">typealias</span> <span class="n">OnFailureCallback</span> <span class="p">=</span> <span class="p">(</span><span class="n">Exception</span><span class="p">?)</span> <span class="p">-&gt;</span> <span class="n">Unit</span>

<span class="kd">class</span> <span class="nc">FacebookManager</span> <span class="p">{</span>
	<span class="k">private</span> <span class="kd">val</span> <span class="py">fbLoginManager</span> <span class="p">=</span> <span class="n">LoginManager</span><span class="p">.</span><span class="n">getInstance</span><span class="p">()</span>
	<span class="k">private</span> <span class="kd">val</span> <span class="py">fbCallbackManager</span> <span class="p">=</span> <span class="n">CallbackManager</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="n">create</span><span class="p">()</span>
	<span class="k">private</span> <span class="kd">var</span> <span class="py">onSuccessCallback</span><span class="p">:</span> <span class="n">OnSuccessCallback</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
	<span class="k">private</span> <span class="kd">var</span> <span class="py">onCancelCallback</span><span class="p">:</span> <span class="n">OnCancelCallback</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
	<span class="k">private</span> <span class="kd">var</span> <span class="py">onFailureCallback</span><span class="p">:</span> <span class="n">OnFailureCallback</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>


	<span class="n">init</span> <span class="p">{</span>
		<span class="n">fbLoginManager</span><span class="p">.</span><span class="n">registerCallback</span><span class="p">(</span><span class="n">fbCallbackManager</span><span class="p">,</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">FacebookCallback</span><span class="p">&lt;</span><span class="n">LoginResult</span><span class="p">&gt;</span> <span class="p">{</span>
			<span class="k">override</span> <span class="k">fun</span> <span class="nf">onSuccess</span><span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="nc">LoginResult</span><span class="p">?)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">getProfile</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">accessToken</span><span class="p">)</span> <span class="p">{</span> <span class="n">user</span> <span class="p">-&gt;</span> <span class="n">onSuccessCallback</span><span class="o">?.</span><span class="n">invoke</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">onFailureCallback</span><span class="o">?.</span><span class="n">invoke</span><span class="p">(</span><span class="n">RuntimeException</span><span class="p">(</span><span class="s">"Auth succeeded but no result - this should never happen"</span><span class="p">))</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">override</span> <span class="k">fun</span> <span class="nf">onCancel</span><span class="p">()</span> <span class="p">{</span> <span class="n">onCancelCallback</span><span class="o">?.</span><span class="n">invoke</span><span class="p">()</span> <span class="p">}</span>

			<span class="k">override</span> <span class="k">fun</span> <span class="nf">onError</span><span class="p">(</span><span class="nv">error</span><span class="p">:</span> <span class="nc">FacebookException</span><span class="p">?)</span> <span class="p">{</span> <span class="n">onFailureCallback</span><span class="o">?.</span><span class="n">invoke</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="p">}</span>
		<span class="p">})</span>
	<span class="p">}</span>

	<span class="k">fun</span> <span class="nf">onSuccess</span><span class="p">(</span><span class="nv">callback</span><span class="p">:</span> <span class="nc">OnSuccessCallback</span><span class="p">):</span> <span class="nc">FacebookManager</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="n">onSuccessCallback</span> <span class="p">=</span> <span class="n">callback</span>
		<span class="k">return</span> <span class="k">this</span>
	<span class="p">}</span>

	<span class="k">fun</span> <span class="nf">onCancel</span><span class="p">(</span><span class="nv">callback</span><span class="p">:</span> <span class="nc">OnCancelCallback</span><span class="p">):</span> <span class="nc">FacebookManager</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="n">onCancelCallback</span> <span class="p">=</span> <span class="n">callback</span>
		<span class="k">return</span> <span class="k">this</span>
	<span class="p">}</span>

	<span class="k">fun</span> <span class="nf">onFailure</span><span class="p">(</span><span class="nv">callback</span><span class="p">:</span> <span class="nc">OnFailureCallback</span><span class="p">):</span> <span class="nc">FacebookManager</span> <span class="p">{</span>
		<span class="k">this</span><span class="p">.</span><span class="n">onFailureCallback</span> <span class="p">=</span> <span class="n">callback</span>
		<span class="k">return</span> <span class="k">this</span>
	<span class="p">}</span>

	<span class="k">fun</span> <span class="nf">getProfile</span><span class="p">(</span><span class="nv">accessToken</span><span class="p">:</span> <span class="nc">AccessToken</span><span class="p">,</span> <span class="nv">callback</span><span class="p">:</span> <span class="nc">OnSuccessCallback</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">val</span> <span class="py">request</span> <span class="p">=</span> <span class="n">GraphRequest</span><span class="p">.</span><span class="n">newMeRequest</span><span class="p">(</span><span class="n">accessToken</span><span class="p">)</span> <span class="p">{</span> <span class="n">jsonObject</span><span class="p">,</span> <span class="n">response</span> <span class="p">-&gt;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">error</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">onFailureCallback</span><span class="o">?.</span><span class="n">invoke</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">error</span><span class="p">.</span><span class="n">exception</span><span class="p">)</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kd">val</span> <span class="py">name</span> <span class="p">=</span> <span class="n">jsonObject</span><span class="p">.</span><span class="n">optString</span><span class="p">(</span><span class="s">"name"</span><span class="p">,</span> <span class="s">"Unknown"</span><span class="p">)</span>
				<span class="kd">val</span> <span class="py">email</span> <span class="p">=</span> <span class="n">jsonObject</span><span class="p">.</span><span class="n">optString</span><span class="p">(</span><span class="s">"email"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
				<span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">AuthenticatedUser</span><span class="p">(</span><span class="n">accessToken</span><span class="p">.</span><span class="n">token</span><span class="p">,</span> <span class="n">AuthenticationProvider</span><span class="p">.</span><span class="n">FACEBOOK</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span>
				<span class="n">callback</span><span class="p">.</span><span class="n">invoke</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">request</span><span class="p">.</span><span class="n">parameters</span> <span class="p">=</span> <span class="n">Bundle</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span> <span class="n">putString</span><span class="p">(</span><span class="s">"fields"</span><span class="p">,</span><span class="s">"id,name,email"</span><span class="p">)</span> <span class="p">}</span>
		<span class="n">request</span><span class="p">.</span><span class="n">executeAsync</span><span class="p">()</span>
	<span class="p">}</span>

	<span class="k">fun</span> <span class="nf">beginSignin</span><span class="p">(</span><span class="nv">activity</span><span class="p">:</span> <span class="nc">Activity</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fbLoginManager</span><span class="p">.</span><span class="n">logInWithReadPermissions</span><span class="p">(</span><span class="n">activity</span><span class="p">,</span> <span class="n">mutableListOf</span><span class="p">(</span><span class="s">"public_profile"</span><span class="p">,</span> <span class="s">"email"</span><span class="p">))</span>
	<span class="p">}</span>

	<span class="k">fun</span> <span class="nf">onActivityResult</span><span class="p">(</span><span class="nv">requestCode</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="nv">resultCode</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="nc">Intent</span><span class="p">?)</span> <span class="p">{</span>
		<span class="n">fbCallbackManager</span><span class="p">.</span><span class="n">onActivityResult</span><span class="p">(</span><span class="n">requestCode</span><span class="p">,</span> <span class="n">resultCode</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Let‚Äôs go through it:</p>

<ul>
  <li>The <code class="highlighter-rouge">onSuccess</code>, <code class="highlighter-rouge">onCancel</code>, and <code class="highlighter-rouge">onFailure</code> methods establish callbacks for later use.  They return <code class="highlighter-rouge">this</code> so I can use them in a fluent manner.</li>
  <li>The <code class="highlighter-rouge">getProfile</code> method is an interesting one that calls the Facebook Graph API to get the name and email address.  Only the name is available in <code class="highlighter-rouge">Profile.getCurrentProfile()</code>.  There are cases where the user has not provided an email (for example, when the user signs up for Facebook with a phone number from a mobile device).  We‚Äôll deal with that wrinkle later on.</li>
  <li>The <code class="highlighter-rouge">beginSignin</code> method is used in the button click-handler to initiate a sign-in.</li>
  <li>The <code class="highlighter-rouge">onActivityResult</code> is the callback method.</li>
</ul>

<p>Most of the code in here is exactly what you would expect if you followed the Facebook instructions.  The <code class="highlighter-rouge">getProfile()</code> method shows how to do a graph request.  I love to use the <a href="https://developers.facebook.com/tools/explorer/">Facebook Graph Explorer</a> to determine what fields I need to ask for and whether I have permissions to read them.  However, you have to be prepared for instances where the information is not available.</p>

<h2 id="prep-your-emulator">Prep your emulator</h2>

<p>You can run this app now in the emulator.  When you press the Facebook logo, it will switch to a web browser, then go through the Facebook authentication before switching back to your app and moving to the MainActivity.   This is pretty awesome already, as it means that a user does not need Facebook on their phone to use your app.  However, you should also install the Facebook app on the emulator and then sign in to the Facebook app.   Once that is complete, restart your app and go through the process again.  Note how the app now switches seamlessly to the Facebook app to ask for permissions, then switches back again.  It‚Äôs a much better experience.</p>

<h2 id="next-steps">Next steps</h2>

<p>I‚Äôve got three authentication providers to go, although the first one is always the hardest since you have to work out how the code flow will happen.  You can find the <a href="https://github.com/adrianhall/tailwind-photos-for-android/tree/blog-2">code for this step on my GitHub repository</a>.</p>
:ET