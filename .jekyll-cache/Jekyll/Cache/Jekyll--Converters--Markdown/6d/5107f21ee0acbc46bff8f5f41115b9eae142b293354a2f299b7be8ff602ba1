I"¡W<p>In a recent post, I described how I can do app analytics by using the AWS Mobile SDK and an AWS Mobile Hub project. This is a great way to get usage analytics for your app, but it requires a tight coupling between the provider (the AWS Provider and <code class="highlighter-rouge">AnalyticsClient</code>) and the app. You need to initialize the provider early on (preferably in the <code class="highlighter-rouge">Application</code> wrapper or the first activity). That causes a tight linkage between the activities where it is used and the client object.</p>

<p>This has several important downsides. Firstly, you canâ€™t test the various components of a real app in isolation. Whenever you do a bit of analytics recording in a class under test, the test will crash because the context isnâ€™t initialized. That means that the pinpointManager isnâ€™t initialized either which means recordEvent() is operating on a null value and you get the dreaded Null Pointer Exception (NPE). Second, you have to know explicitly about the specifics of the implementation.</p>

<p>There is a better way and it comes in the form of dependency injection (DI). This is a tool that you can use to separate the implementation and initialization of a service from its usage. In tests, you can write a mock analytics service, for instance, that just logs (or does nothing). When you build the real app, you can inject the appropriate <a href="https://aws.amazon.com/pinpoint">Amazon Pinpoint</a> version and analytics events are recorded as you would expect.</p>

<p>There are a number of options for dependency injection in Android:</p>

<ul>
  <li><a href="https://google.github.io/dagger/">Dagger-2</a> (favored by Google at the moment)</li>
  <li><a href="https://academy.realm.io/posts/droidcon-boston-daniel-molinero-toothpick-dependency-injection-android/">Toothpick</a></li>
  <li><a href="http://kodein.org/Kodein-DI/">Kodein</a></li>
  <li><a href="https://insert-koin.io/">Koin</a></li>
</ul>

<p>You could also use a simple service locator pattern and bypass dependency injection altogether. Thereâ€™s no need to go to the trouble of dependency injection if you donâ€™t need it. As your app becomes more complex, you will find dependency injection more helpful.</p>

<p>In this article, Iâ€™m going to be using Koin. I found Dagger-2 to be complex and has too much boilerplate. It took a while to understand and get right. Toothpick and Kodein were much nicer from that perspective. I found Koin to be the easiest to understand after I had gone through a simple example. So letâ€™s get coding!</p>

<h2 id="step-1-create-an-interface-for-the-service">Step 1: Create an interface for the service</h2>

<p>Before you get too deep into the mechanics for dependency injection, youâ€™re going to need to create an interface for a service, and then create a concrete implementation for that interface. By creating an interface (and using it everywhere), you can swap out the implementation when you want. In tests, youcan swap in a mock implementation. In production, you can swap in an Amazon Pinpoint version. If, later on, you want to write to Amazon Kinesis or some other analytics provider instead, you can do that easily without changing the rest of the code. Just create the new implementation and then provide it via the dependency injection system. Hereâ€™s my <code class="highlighter-rouge">AnalyticsService</code> interface:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="k">package</span> <span class="nn">com.shellmonger.apps.familyphotos.services</span>

<span class="kd">interface</span> <span class="nc">AnalyticsService</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">startSession</span><span class="p">()</span>
    <span class="k">fun</span> <span class="nf">stopSession</span><span class="p">()</span>
    <span class="k">fun</span> <span class="nf">recordEvent</span><span class="p">(</span><span class="nv">type</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>Note that Iâ€™m not specifying the application context anywhere. Iâ€™m not initializing the object. Iâ€™m just specifying the methods that my components will use.</p>

<h2 id="step-2-create-a-concrete-implementation-for-the-service">Step 2: Create a concrete implementation for the service</h2>

<p>Actually, create two implementations.  The first is the <code class="highlighter-rouge">MockAnalyticsService</code>:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="k">package</span> <span class="nn">com.shellmonger.apps.familyphotos.services</span>

<span class="k">import</span> <span class="nn">android.util.Log</span>

<span class="kd">class</span> <span class="nc">MockAnalyticsService</span> <span class="p">:</span> <span class="n">AnalyticsService</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">TAG</span> <span class="p">=</span> <span class="k">this</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">.</span><span class="n">simpleName</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">startSession</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">"startSession"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">stopSession</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">"stopSession"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">recordEvent</span><span class="p">(</span><span class="nv">type</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">"recordEvent($type)"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>And the second is for the <code class="highlighter-rouge">AWSAnalyticsService</code>:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="code"><pre><span class="k">package</span> <span class="nn">com.shellmonger.apps.familyphotos.services</span>

<span class="k">import</span> <span class="nn">android.content.Context</span>
<span class="k">import</span> <span class="nn">android.util.Log</span>
<span class="k">import</span> <span class="nn">com.amazonaws.auth.CognitoCachingCredentialsProvider</span>
<span class="k">import</span> <span class="nn">com.amazonaws.mobile.config.AWSConfiguration</span>
<span class="k">import</span> <span class="nn">com.amazonaws.mobileconnectors.pinpoint.PinpointConfiguration</span>
<span class="k">import</span> <span class="nn">com.amazonaws.mobileconnectors.pinpoint.PinpointManager</span>

<span class="kd">class</span> <span class="nc">AWSAnalyticsService</span><span class="p">(</span><span class="nv">context</span><span class="p">:</span> <span class="nc">Context</span><span class="p">)</span> <span class="p">:</span> <span class="nc">AnalyticsService</span> <span class="p">{</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">TAG</span> <span class="p">=</span> <span class="k">this</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">.</span><span class="n">simpleName</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">pinpointManager</span><span class="p">:</span> <span class="n">PinpointManager</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">startSession</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">with</span> <span class="p">(</span><span class="n">pinpointManager</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sessionClient</span><span class="p">.</span><span class="n">startSession</span><span class="p">()</span>
            <span class="n">analyticsClient</span><span class="p">.</span><span class="n">submitEvents</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">stopSession</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">with</span> <span class="p">(</span><span class="n">pinpointManager</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sessionClient</span><span class="p">.</span><span class="n">stopSession</span><span class="p">()</span>
            <span class="n">analyticsClient</span><span class="p">.</span><span class="n">submitEvents</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">recordEvent</span><span class="p">(</span><span class="nv">type</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">with</span> <span class="p">(</span><span class="n">pinpointManager</span><span class="p">.</span><span class="n">analyticsClient</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">val</span> <span class="py">event</span> <span class="p">=</span> <span class="n">createEvent</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
            <span class="n">recordEvent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
            <span class="n">submitEvents</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">init</span> <span class="p">{</span>
        <span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">"constructor - context = ${context}"</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">awsConfiguration</span> <span class="p">=</span> <span class="n">AWSConfiguration</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">credentialsProvider</span> <span class="p">=</span> <span class="n">CognitoCachingCredentialsProvider</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">awsConfiguration</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">pinpointConfiguration</span> <span class="p">=</span> <span class="n">PinpointConfiguration</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">credentialsProvider</span><span class="p">,</span> <span class="n">awsConfiguration</span><span class="p">)</span>
        <span class="n">pinpointManager</span> <span class="p">=</span> <span class="n">PinpointManager</span><span class="p">(</span><span class="n">pinpointConfiguration</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>They both implement the <code class="highlighter-rouge">AnalyticsService</code> interface, so they can be used interchangeably by any object that has a reference to an object defined (for example) like this:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="k">package</span> <span class="nn">com.shellmonger.apps.familyphotos.lifecycle</span>

<span class="k">import</span> <span class="nn">android.app.Application</span>
<span class="k">import</span> <span class="nn">com.shellmonger.apps.familyphotos.services.AWSAnalyticsService</span>
<span class="k">import</span> <span class="nn">com.shellmonger.apps.familyphotos.services.AnalyticsService</span>

<span class="kd">class</span> <span class="nc">ApplicationWrapper</span> <span class="p">:</span> <span class="n">Application</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="py">analyticsService</span><span class="p">:</span> <span class="n">AnalyticsService</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">()</span>
        <span class="n">analyticsService</span> <span class="p">=</span> <span class="n">AWSAnalyticsService</span><span class="p">(</span><span class="n">applicationContext</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Now you can use <code class="highlighter-rouge">AnalyticsService</code> anywhere you need. The application wrapper lives for the life of the app, so itâ€™s always available. However, this is unscalable in complex apps. You end up placing all these service locators in their own class as singletons and it gets messy pretty quickly.</p>

<h2 id="step-3-add-the-koin-libraries">Step 3: Add the Koin libraries</h2>

<p>Now we get to integrate Koin. Hereâ€™s the addition to the dependencies section of the app <code class="highlighter-rouge">build.gradle</code>:</p>

<figure class="highlight"><pre><code class="language-gradle" data-lang="gradle"><span class="c1">// Dependency Injection</span>
<span class="n">implementation</span> <span class="s2">"org.koin:koin-android:$koin_version"</span></code></pre></figure>

<p>The latest Koin version is 0.9.2.</p>

<h2 id="step-4-create-a-di-module">Step 4: Create a DI module</h2>

<p>You need to declare a module to let Koin know what things can be injected. Hereâ€™s my module:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="kd">val</span> <span class="py">appModule</span> <span class="p">:</span> <span class="n">Module</span> <span class="p">=</span> <span class="n">applicationContext</span> <span class="p">{</span>
    <span class="n">bean</span> <span class="p">{</span> <span class="n">AWSAnalyticsService</span><span class="p">(</span><span class="k">get</span><span class="p">())</span> <span class="k">as</span> <span class="n">AnalyticsService</span> <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>I place this in the top of the <code class="highlighter-rouge">ApplicationWrapper</code> class for convenience. This way, my <code class="highlighter-rouge">ApplicationWrapper</code> defines the entire context of the dependency injection system within the companion object. However, you can also put the module in another file (and probably should). You can also split your dependency injection graph into multiple modules.</p>

<p>Use <code class="highlighter-rouge">bean</code> if your service should be a singleton. Most cloud services and data services fall into this category. You only want one database connection, for example. You want cloud services to take advantage of bandwidth optimization by caching. They do that by using a singleton pattern. If you donâ€™t want a singleton, use <code class="highlighter-rouge">factory</code> instead of <code class="highlighter-rouge">bean</code>.</p>

<p>Note the use of <code class="highlighter-rouge">get()</code>â€Šâ€”â€Šthis allows you to use recursive dependency injection. The <code class="highlighter-rouge">get()</code> will be resolved prior to injection based on what is required.</p>

<h2 id="step-5-initialize-koin">Step 5: Initialize Koin</h2>

<p>Your application wrapper should resemble this:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="kd">class</span> <span class="nc">ApplicationWrapper</span> <span class="p">:</span> <span class="n">Application</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">companion</span> <span class="k">object</span> <span class="p">{</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">appModule</span> <span class="p">:</span> <span class="n">Module</span> <span class="p">=</span> <span class="n">applicationContext</span> <span class="p">{</span>
      <span class="n">bean</span> <span class="p">{</span> <span class="n">AWSAnalyticsService</span><span class="p">(</span><span class="k">get</span><span class="p">())</span> <span class="k">as</span> <span class="n">AnalyticsService</span> <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">()</span>
    <span class="c1">// Initialize Koin dependency injection</span>
    <span class="n">startKoin</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">listOf</span><span class="p">(</span><span class="n">appModule</span><span class="p">))</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Remove the static reference to the analytics client (if you added it). It will be injected when needed now.</p>

<p>If you have multiple modules, just add them as a comma-delimited list inside the <code class="highlighter-rouge">listOf()</code> operator. Note that this is an improvement over the previous use of the singleton instance variable. Less boiler plate code is a good thing.</p>

<h2 id="step-6-inject-into-your-classes">Step 6: Inject into your classes</h2>

<p>Finally, you need to adjust your components so that they use the injected version of the <code class="highlighter-rouge">AnalyticsService</code>. Hereâ€™s my <code class="highlighter-rouge">SplashActivity</code> as an example:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre></td><td class="code"><pre><span class="k">package</span> <span class="nn">com.shellmonger.apps.familyphotos.ui</span>

<span class="k">import</span> <span class="nn">android.support.v7.app.AppCompatActivity</span>
<span class="k">import</span> <span class="nn">android.os.Bundle</span>
<span class="k">import</span> <span class="nn">com.shellmonger.apps.familyphotos.R</span>
<span class="k">import</span> <span class="nn">com.shellmonger.apps.familyphotos.services.AnalyticsService</span>
<span class="k">import</span> <span class="nn">org.koin.android.ext.android.inject</span>

<span class="kd">class</span> <span class="nc">SplashActivity</span> <span class="p">:</span> <span class="n">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">analyticsService</span><span class="p">:</span> <span class="n">AnalyticsService</span> <span class="k">by</span> <span class="n">inject</span><span class="p">()</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(</span><span class="nv">savedInstanceState</span><span class="p">:</span> <span class="nc">Bundle</span><span class="p">?)</span> <span class="p">{</span>
        <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(</span><span class="n">savedInstanceState</span><span class="p">)</span>
        <span class="n">setContentView</span><span class="p">(</span><span class="n">R</span><span class="p">.</span><span class="n">layout</span><span class="p">.</span><span class="n">activity_splash</span><span class="p">)</span>

        <span class="n">analyticsService</span><span class="p">.</span><span class="n">startSession</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>The injection is at line 10.  Once injected, I can use it anywhere.  You can now run your app and youâ€™ll see the same analytics as you previously had. If you look at the debugging, you might see the following:</p>

<p><img src="/assets/images/2018-04-06-image1.png" alt="" /></p>

<p>You can clearly see here that the <code class="highlighter-rouge">AnalyticsService</code> was resolved, but that caused an additional resolution for the context. The context that was provided was the application context.</p>

<h2 id="wrap-up">Wrap up</h2>
<p>If youâ€™re producing a production app, you should consider structuring your app to use either dependency injection or a simple service locator. The more complicated the app is(defined as more services / data models), then the more likely it is that dependency injection will be an improvement.</p>

<p>Both a service locator and dependency injection will improve your testing capabilities if you organize your code into uniquely testable units. You can take a look at the <a href="https://developer.android.com/topic/libraries/architecture/index.html">Android Architecture Components</a> for a method on how to do this.</p>

<!-- AWS Links -->

<!-- Consoles -->

<!-- My Links -->

:ET