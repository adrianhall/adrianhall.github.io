I":d<p>This will be an in-depth series on authentication with [AWS Amplify]. Here are the topics I am going to cover, and I will update each blog with the links as I complete the articles.</p>

<ul>
  <li><a href="/android/2018/09/18/auth-with-aws-amplify-1/">The basics - a username/password system</a>.</li>
  <li><a href="/android/2018/09/23/auth-with-aws-amplify-2/">Customizing the UI</a>.</li>
  <li><a href="/android/2018/10/01/auth-with-aws-amplify-3/">Authenticating with Facebook</a>.</li>
  <li><a href="/android/2018/10/08/auth-with-aws-amplify-4/">Authenticating with Google</a>.</li>
  <li><a href="/android/2018/10/15/auth-with-aws-amplify-5/">Using third-party authentication providers</a>.</li>
  <li><a href="/android/2018/10/22/auth-with-aws-amplify-6/">Using Time-based One-time passwords (TOTP)</a>.</li>
  <li><a href="/android/2018/10/29/auth-with-aws-amplify-7/">Using Biometric authentication</a>.</li>
  <li><a href="/android/2018/11/05/auth-with-aws-amplify-8/">Doing fraud protection and analytics</a>.</li>
</ul>

<p>This is part 3 — authenticating with Facebook. It builds on what we have done in parts 1 and 2. If you haven’t looked at the identity repository and how to build a custom UI, you should definitely go do that first.</p>

<p>So far, we’ve covered implementing a username and password authentication scheme with Amazon Cognito user pools. We’ve looked at how to get the basics going, connecting the sign in action to a button, and customizing all the flows — sign-in, sign-up and self-service password reset.</p>

<p>Most users don’t want to remember yet another password, however. Giving the user the option to use Facebook, Google, or some other authentication provider is a good practice. In the new couple of articles, I’m going to walk through configuring the authentication system so that we can use these third party authentication providers, starting with Facebook.</p>

<p>The process is fairly simple, but it is a multi-step process:</p>

<ol>
  <li>Get an Application ID from the Facebook Developers console.</li>
  <li>Add your application to the Facebook Application registration.</li>
  <li>Configure the Amazon Cognito identity pool to federate using the application ID you just received.</li>
  <li>Integrate the Facebook authentication provider into your app.</li>
  <li>Send the Facebook authentication token you receive from signing in with Facebook to the Amazon Cognito identity pool for federation.</li>
</ol>

<h2 id="step-1-get-an-application-id-from-facebook">Step 1: Get an Application ID from Facebook</h2>

<p>I should note here that every single web site on the planet changes over time. While I will put a specific process down here, it is “at time of writing”. Things may change by the time you read this. The end result is important — you want an application ID for logging in with Facebook.</p>

<p>First, log in to the <a href="https://developers.facebook.com/">Facebook Developers portal</a>. If you have never visited this portal before, there is a sign-up agreement to become a Facebook developer. Depending on whether you have created an app before:</p>

<ul>
  <li>If you don’t have any apps registered, click the big friendly green <strong>Add a New App</strong> button.</li>
  <li>If you have registered an app, click the <strong>My Apps</strong> menu, then <strong>Create a New App</strong>.</li>
</ul>

<p>The form will have already filled in the contact email — you just have to fill in the display name, then click <strong>Create App ID</strong>. There may be a security check, and then you are onto app configuration.</p>

<h2 id="step-2-add-your-application-to-the-application-registration">Step 2: Add your application to the Application registration</h2>

<p>Facebook needs to know which specific applications are going to be using the Facebook login. To do that, you need to give Facebook the key hash for your mobile app. First, you need to generate a development key for your Android environment:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">keytool <span class="nt">-exportcert</span> <span class="nt">-alias</span> androiddebugkey <span class="nt">-keystore</span> ~/.android/debug.keystore | openssl sha1 <span class="nt">-binary</span> | openssl <span class="nb">base64</span></code></pre></figure>

<p>You will be prompted to enter a key store password (which can be anything — you are generating a password), then you get a string of characters ending in the equals sign. You need this later on, so don’t lose it.</p>

<p>Back in the Facebook developers console:</p>

<ul>
  <li>Click <strong>Settings</strong> &gt; <strong>Basic</strong> in the left-hand menu.</li>
  <li>Scroll to the bottom of the page, then click <strong>Add Platform</strong>.</li>
  <li>Select <strong>Android</strong> from the list.</li>
  <li>Turn the <strong>Single Sign On</strong> switch to <strong>Yes</strong>.</li>
  <li>Set the <strong>Google Play Package Name</strong> to be the package name of your app (in my case, it is <em>com.amazonaws.mobile.samples.picturefeed</em>)</li>
  <li>Set the <strong>Class Name</strong> to be the activity that will receive the deep link for when Facebook returns control to your app. In my case, this is <em>com.amazonaws.mobile.samples.picturefeed.ui.auth.AuthenticatorActivity</em>.</li>
  <li>Set the <strong>Key Hashes</strong> to be the result of the keytool output from earlier in this step.</li>
  <li>Click <strong>Save Changes</strong>.</li>
  <li>You probably have not registered the name space with Google Play yet, so click <strong>Use this package name</strong> when prompted. (This prompt will not appear if you have registered the name space with Google Play).</li>
</ul>

<p>There are two modes for Facebook apps — Development and Production. Only users who have been registered as testers will be able to authenticate with your app while it is in development. You and your friends are automatically testers, but if you need to add someone else:</p>

<ul>
  <li>Click <strong>Roles</strong> &gt; <strong>Roles</strong> in the left-hand menu.</li>
  <li>Click <strong>Add Testers</strong>.</li>
  <li>Enter the name, fbid or username of the person, then click <strong>Submit</strong>.</li>
</ul>

<p>You can find the users username easily enough. Go to their profile on the main Facebook site. Their username is listed in the URL.</p>

<h2 id="step-3-add-facebook-to-the-amazon-cognito-identity-pool">Step 3: Add Facebook to the Amazon Cognito identity pool</h2>

<p>Since we are using <a href="https://aws-amplify.github.io/">AWS Amplify CLI</a> for our backend configuration, this becomes easily accomplished:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">amplify update auth</code></pre></figure>

<p>The answers to the questions are the same, except for this one:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>? Do you want to enable 3rd party authentication providers in your identity pool (Use arrow keys)
</code></pre></div></div>

<p>Answer <strong>Yes</strong> here. Then select <strong>Facebook</strong>. Cut and paste the App ID into the appropriate slot.</p>

<p>At this point, the Facebook configuration is done. You still have to do the rest of the authentication setup. However, we have previously set all this up, so you can press Enter the rest of the way.</p>

<p>The final step is to deploy the backend:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">amplify push</code></pre></figure>

<blockquote>
  <p>Want to take a look at what is happening behind the scenes? All the configuration is placed in an Amazon CloudFormation template (with one template per Amplify category). Take a look in <code class="highlighter-rouge">amplify/backend/auth</code> for the details on the authentication settings.</p>
</blockquote>

<h2 id="step-4-integrate-the-facebook-sdk-into-your-app">Step 4: Integrate the Facebook SDK into your app</h2>

<p>You should always follow the <a href="https://developers.facebook.com/docs/facebook-login/android">Facebook documentation</a> for the latest instructions. However, here is how I integrated it into my app. Start by adding the SDK into your app dependencies within <code class="highlighter-rouge">build.gradle</code>:</p>

<figure class="highlight"><pre><code class="language-gradle" data-lang="gradle"><span class="n">implementation</span> <span class="s1">'com.facebook.android:facebook-login:4.36.0'</span></code></pre></figure>

<p>Ensure you sync your project. Now, add the following two lines to your <code class="highlighter-rouge">strings.xml</code> file:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">"facebook_app_id"</span><span class="nt">&gt;</span>YOUR-APP-ID<span class="nt">&lt;/string&gt;</span>
<span class="nt">&lt;string</span> <span class="na">name=</span><span class="s">"fb_login_protocol_scheme"</span><span class="nt">&gt;</span>fbYOUR-APP-ID<span class="nt">&lt;/string&gt;</span></code></pre></figure>

<p>Replace <em>YOUR-APP-ID</em> with your Facebook App ID from the Facebook Developers portal. Now, edit your <code class="highlighter-rouge">AndroidManifest.xml</code> You should already have the <code class="highlighter-rouge">INTERNET</code> permission (but add it if you don’t). Add the following meta-data element inside the application node:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="c">&lt;!-- Facebook Requirements --&gt;</span>
<span class="nt">&lt;meta-data</span>
    <span class="na">android:name=</span><span class="s">"com.facebook.sdk.ApplicationId"</span>
    <span class="na">android:value=</span><span class="s">"@string/facebook_app_id"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;activity</span>
    <span class="na">android:name=</span><span class="s">"com.facebook.FacebookActivity"</span>
    <span class="na">android:configChanges=</span><span class="s">"keyboard|keyboardHidden|screenLayout|screenSize|orientation"</span>
    <span class="na">android:label=</span><span class="s">"@string/app_name"</span><span class="nt">/&gt;</span></code></pre></figure>

<p>There are two more steps that we need to do. Firstly, we need to add a Facebook button to the login screen. This is included in the XML for my layout:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;com.facebook.login.widget.LoginButton</span>
    <span class="na">android:id=</span><span class="s">"@+id/loginFormFacebookLoginButton"</span>
    <span class="na">android:layout_width=</span><span class="s">"wrap_content"</span>
    <span class="na">android:layout_height=</span><span class="s">"wrap_content"</span>
    <span class="na">android:layout_gravity=</span><span class="s">"start"</span> <span class="nt">/&gt;</span></code></pre></figure>

<p>Then, in the <code class="highlighter-rouge">onCreate()</code> method of the <code class="highlighter-rouge">AuthenticatorActivity</code>, I’ve included the following:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="n">loginFormFacebookLoginButton</span><span class="p">.</span><span class="n">setReadPermissions</span><span class="p">(</span><span class="n">listOf</span><span class="p">(</span><span class="s">"email"</span><span class="p">))</span></code></pre></figure>

<p>This pulls the email address of the user in addition to their public profile. Be careful what you ask for as asking for some items trigger an additional app review.</p>

<p>The second thing you must do is to register a callback to receive the result of the login. Create a callback manager within the <code class="highlighter-rouge">AuthenticatorActivity</code> and handle the activity result return:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="c1">// Facebook Requirement</span>
<span class="k">private</span> <span class="kd">val</span> <span class="py">callbackManager</span><span class="p">:</span> <span class="n">CallbackManager</span> <span class="p">=</span> <span class="n">CallbackManager</span><span class="p">.</span><span class="n">Factory</span><span class="p">.</span><span class="n">create</span><span class="p">()</span>

<span class="k">override</span> <span class="k">fun</span> <span class="nf">onActivityResult</span><span class="p">(</span><span class="nv">requestCode</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="nv">resultCode</span><span class="p">:</span> <span class="nc">Int</span><span class="p">,</span> <span class="nv">data</span><span class="p">:</span> <span class="nc">Intent</span><span class="p">?)</span> <span class="p">{</span>
    <span class="c1">// Handle response from Facebook SDK</span>
    <span class="n">callbackManager</span><span class="p">.</span><span class="n">onActivityResult</span><span class="p">(</span><span class="n">requestCode</span><span class="p">,</span> <span class="n">resultCode</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onActivityResult</span><span class="p">(</span><span class="n">requestCode</span><span class="p">,</span> <span class="n">resultCode</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>Then, in the <code class="highlighter-rouge">onCreate()</code> method, register the callback:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="c1">// Register the callback for the Facebook authentication</span>
<span class="n">LoginManager</span><span class="p">.</span><span class="n">getInstance</span><span class="p">().</span><span class="n">registerCallback</span><span class="p">(</span><span class="n">callbackManager</span><span class="p">,</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">FacebookCallback</span><span class="p">&lt;</span><span class="n">LoginResult</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onSuccess</span><span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="nc">LoginResult</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">"Facebook token = ${result?.accessToken?.token}"</span><span class="p">)</span>
        <span class="n">toast</span><span class="p">(</span><span class="s">"Access Token received"</span><span class="p">)</span>
   <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCancel</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">"Facebook authentication is cancelled"</span><span class="p">)</span>
        <span class="n">toast</span><span class="p">(</span><span class="s">"Facebook Authentication is cancelled"</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onError</span><span class="p">(</span><span class="nv">error</span><span class="p">:</span> <span class="nc">FacebookException</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">Log</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">"Facebook Authentication failed: ${error?.message}"</span><span class="p">)</span>
        <span class="n">toast</span><span class="p">(</span><span class="s">"Facebook Authentication failed: ${error?.message}"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">})</span></code></pre></figure>

<p>You should now be able to run your app and authenticate with Facebook, but it doesn’t actually authenticate with the app as the callback doesn’t do anything with the access token.</p>

<h2 id="step-5-federate-with-amazon-cognito-identity-pools">Step 5: Federate with Amazon Cognito identity pools</h2>

<p>The final piece of the puzzle is to make Amazon Cognito aware that we have logged in with Facebook. Firstly, I am going to add a method to our Identity Repository called <code class="highlighter-rouge">federateWithFacebook</code> that takes an access token and sends it to Amazon Cognito. Here is the AWS implementation:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="cm">/**</span><span class="err">
</span><span class="cm">  * Federate with Facebook authentication</span><span class="err">
</span><span class="cm">  */</span>
<span class="k">override</span> <span class="k">fun</span> <span class="nf">federateWithFacebook</span><span class="p">(</span><span class="nv">accessToken</span><span class="p">:</span> <span class="nc">AccessToken</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">"Federating with Facebook"</span><span class="p">)</span>
    <span class="n">thread</span><span class="p">(</span><span class="n">start</span> <span class="p">=</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">with</span><span class="p">(</span><span class="n">service</span><span class="p">.</span><span class="n">identityManager</span><span class="p">.</span><span class="n">underlyingProvider</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">clear</span><span class="p">()</span>
            <span class="n">withLogins</span><span class="p">(</span><span class="n">mapOf</span><span class="p">(</span><span class="s">"graph.facebook.com"</span> <span class="n">to</span> <span class="n">accessToken</span><span class="p">.</span><span class="n">token</span><span class="p">))</span>
            <span class="n">refresh</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="kd">val</span> <span class="py">user</span> <span class="p">=</span> <span class="n">User</span><span class="p">().</span><span class="n">apply</span> <span class="p">{</span>
            <span class="n">username</span> <span class="p">=</span> <span class="n">accessToken</span><span class="p">.</span><span class="n">userId</span>
            <span class="n">tokens</span><span class="p">[</span><span class="n">TokenType</span><span class="p">.</span><span class="n">ACCESS_TOKEN</span><span class="p">]</span> <span class="p">=</span> <span class="n">accessToken</span><span class="p">.</span><span class="n">token</span>
            <span class="n">userAttributes</span><span class="p">[</span><span class="s">"provider"</span><span class="p">]</span> <span class="p">=</span> <span class="s">"graph.facebook.com"</span>
        <span class="p">}</span>
        <span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">"Federated result: ${service.identityManager.isUserSignedIn}"</span><span class="p">)</span>
        <span class="n">runOnUiThread</span> <span class="p">{</span> <span class="n">mCurrentUser</span><span class="p">.</span><span class="n">postValue</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>I also need to add a little bit of code into the <code class="highlighter-rouge">init</code> block of the identity repository to read the Facebook access token:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="c1">// Check to see if Facebook is authenticated</span>
<span class="c1">// if it is, then federate with facebook</span>
<span class="kd">val</span> <span class="py">accessToken</span> <span class="p">=</span> <span class="n">AccessToken</span><span class="p">.</span><span class="n">getCurrentAccessToken</span><span class="p">()</span>
<span class="k">if</span> <span class="p">(</span><span class="n">accessToken</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">accessToken</span><span class="p">.</span><span class="n">isExpired</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">federateWithFacebook</span><span class="p">(</span><span class="n">accessToken</span><span class="p">)</span>
<span class="p">}</span></code></pre></figure>

<p>Finally, I can adjust the <code class="highlighter-rouge">onSuccess()</code> method of my Facebook login callback to close the activity is the authentication is successful:</p>

<figure class="highlight"><pre><code class="language-kotlin" data-lang="kotlin"><span class="c1">// Register the callback for the Facebook authentication</span>
<span class="n">LoginManager</span><span class="p">.</span><span class="n">getInstance</span><span class="p">().</span><span class="n">registerCallback</span><span class="p">(</span><span class="n">callbackManager</span><span class="p">,</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">FacebookCallback</span><span class="p">&lt;</span><span class="n">LoginResult</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onSuccess</span><span class="p">(</span><span class="nv">result</span><span class="p">:</span> <span class="nc">LoginResult</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">result</span><span class="o">?.</span><span class="n">let</span> <span class="p">{</span> <span class="n">model</span><span class="p">.</span><span class="n">federateWithFacebook</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">accessToken</span><span class="p">)</span> <span class="p">}</span>
        <span class="k">this</span><span class="nd">@AuthenticatorActivity</span><span class="p">.</span><span class="n">finish</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCancel</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">Log</span><span class="p">.</span><span class="n">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">"Facebook authentication is cancelled"</span><span class="p">)</span>
        <span class="n">toast</span><span class="p">(</span><span class="s">"Facebook Authentication is cancelled"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">override</span> <span class="k">fun</span> <span class="nf">onError</span><span class="p">(</span><span class="nv">error</span><span class="p">:</span> <span class="nc">FacebookException</span><span class="p">?)</span> <span class="p">{</span>
        <span class="n">Log</span><span class="p">.</span><span class="n">e</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span> <span class="s">"Facebook Authentication failed: ${error?.message}"</span><span class="p">)</span>
        <span class="n">toast</span><span class="p">(</span><span class="s">"Facebook Authentication failed: ${error?.message}"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">})</span></code></pre></figure>

<p>Phew!</p>

<p>There is a lot more to do here and subtleties with the Facebook authentication that must be taken care of. Note, however, the following:</p>

<ul>
  <li>You must use an Amazon Cognito identity pool. Even though Amazon Cognito user pools can do Facebook authentication, you can’t combine that functionality with a user pool in a mobile app.</li>
  <li>There is no “sign out” functionality with Facebook. You have to sign out of Amazon Cognito (using the sign out button), then sign out again when you click on Facebook again! If you close and re-open the app, Facebook is still authenticated and you will be re-signed in. (Yes, not ideal).</li>
  <li>In an emulator, you don’t have Facebook installed, so you will be prompted for a username and password (and potentially a code). However, in a “real world” scenario, the app will switch to Facebook, ask you to approve the app login, then switch back to your app.</li>
  <li>If you are using the Amazon <code class="highlighter-rouge">auth-ui</code> package and the basic UI, then you can easily add Facebook authentication with just a couple of lines of code. Check <a href="https://docs.aws.amazon.com/aws-mobile/latest/developerguide/add-aws-mobile-user-sign-in.html">the documentation</a> for detailed instructions.</li>
</ul>

<p>Next time, I’ll be covering Google authentication, which looks remarkably similar.</p>
:ET