I"d@<p>I am building a GraphQL API for a restaurant review app, and thus far, I’ve:</p>

<ul>
  <li><a href="/cloud/2018/11/15/restaurant-reviews/">Designed the schema</a>.</li>
  <li><a href="/cloud/2018/11/30/restaurant-reviews-part-2/">Developed a suitable data layer backend</a>.</li>
  <li><a href="/cloud/2018/12/06/restaurant-reviews-part-3/">Developed “most” of the resolvers for the queries and mutations</a>.</li>
</ul>

<p>When developing the resolvers in the last blog post, I left out what is probably the most complex and useful of the queries — the <em>findLocation</em> query. This query is central to my app and involves geospatial searching. I included an ElasticSearch instance in my data layer backend purely for this capability.</p>

<h2 id="implementing-geospatial-data-storage">Implementing geospatial data storage</h2>

<p>Before we get started, we need to configure the ElasticSearch Service search domain with geospatial support. The appropriate data type is a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/geo-point.html"><em>geo_point</em></a> which represents a geospatial point with a longitude and latitude. There are a few ways to represent a geo-point within ElasticSearch indices, but the one we are going to use is an object:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"gps": {
  "lat": &lt;some-float&gt;,
  "lon": &lt;some-float&gt;
}
</code></pre></div></div>

<p>The fields <strong>MUST</strong> be called <code class="highlighter-rouge">lat</code> and <code class="highlighter-rouge">lon</code>. Nothing else will do. Fortunately, my schema already uses that form, so I can use those names. However, if you used (for example) <code class="highlighter-rouge">latitude</code> and <code class="highlighter-rouge">longitude</code> then you would have to rename those fields within the mapping template.</p>

<p>First, create the index using the Kibana Dev Tools:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Create the index
PUT devrestaurantreviews
{
    "settings" : {
        "index" : {
            "number_of_shards" : 3,
            "number_of_replicas" : 1
        }
    }
}
</code></pre></div></div>

<p>Then adjust the mapping so that the <code class="highlighter-rouge">gps</code> field is a <code class="highlighter-rouge">geo_point</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Update to make the gps coords a geo_point for geospatial search
PUT devrestaurantreviews/_mapping/doc
{
  "properties": {
    "gps": {
      "type": "geo_point"
    }
  }
}
</code></pre></div></div>

<blockquote>
  <p>You can also combine these two sections into a single call.  Refer to <a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.5/indices-create-index.html">the ElasticSearch documentation</a> for more information.</p>
</blockquote>

<p>The <code class="highlighter-rouge">gps</code> field is the field within the <code class="highlighter-rouge">Location</code> type. The name of the field must uniquely represent a geo-point as all fields with this name (including those within other types) will be configured to be a geo_point. This also <strong>MUST</strong> be done prior to any data being stored in the index. As a result, you will want to wipe out your DynamoDB table contents and start over.</p>

<blockquote>
  <p>You can use <a href="https://www.npmjs.com/package/serverless-plugin-scripts"><code class="highlighter-rouge">serverless-plugin-scripts</code></a> and execute a Lambda function on successful deployment that executes these commands. Check out <a href="https://github.com/adrianhall/restaurant-reviews">the GitHub repository</a> for an example.</p>
</blockquote>

<p>If you have already created the ES index, you can use Kibana Dev Tools to delete it:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DELETE devrestaurantreviews
</code></pre></div></div>

<p>Then re-create the index as above and store the mapping. Now, go over to the AWS AppSync console, add a location with GPS coordinates, then wait for the record to appear in the ES index. You can search for “all records” in Kibana Dev Tools like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET _search
{
  "query": {
    "match_all": {}
  }
}
</code></pre></div></div>

<h2 id="doing-a-geospatial-search">Doing a geospatial search</h2>

<p>Let’s continue in the Kibana Dev Tools and look at what a geospatial search looks like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET _search
{
  "query": {
    "bool": {
      "must": [
        { "match": { "typeName": "LOCATION" } }
      ],
      "filter": {
        "geo_distance": {
          "distance": "10km",
          "gps": {
            "lat": -47.615,
            "lon": -122.330
          }
        }
      }
    }
  }
}
</code></pre></div></div>

<p>If I have any entries within 10km of the identified search location, then there will be “hits” that match.</p>

<h2 id="the-findlocation-request-mapping-template">The findLocation request mapping template</h2>

<p>Let’s now turn our attention to the <em>findLocation</em> resolver. It actually has two fields — <em>byGPS</em> and <em>byAddress</em>. Theoretically, these can be used in concert, so we need to know what that means. <em>byGPS</em> is easy — it takes a set of GPS coordinates and a distance (measured in km), and constructs the filter. The <em>byAddress</em> will try to exactly match the address fields that are entered. If you enter both, then the query will be ANDed together. Thus, we could end up with a search like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET _search
{
  "query": {
    "bool": {
      "must": [
        { "match": { "typeName": "LOCATION" } },
        { "match": { "address.zipcode": "98101" } }
      ],
      "filter": {
        "geo_distance": {
          "distance": "10km",
          "gps": {
            "lat": 47.615,
            "lon": -122.330
          }
        }
      }
    }
  }
}
</code></pre></div></div>

<p>Here is what I came up with for the request mapping template:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
#set($query = {
  "bool": {
    "must": [
      { "match": { "typeName": "LOCATION" } }
    ]
  }
})

#if (! $util.isNull($context.args.byGPS ))
  $util.qr($query.bool.put("filter", {
  	"geo_distance": {
    	"distance": "${context.args.byGPS.radius}km",
        "gps": $context.args.byGPS.gps
    }
  }))
#end

#if (! $util.isNull($context.args.byAddress ))
  #if (! $util.isNull($context.args.byAddress.street ))
    $util.qr($query.bool.must.add({ "match": { "address.street": "$context.args.byAddress.street" } }))
  #end
  #if (! $util.isNull($context.args.byAddress.city ))
    $util.qr($query.bool.must.add({ "match": { "address.city": "$context.args.byAddress.city" } }))
  #end
  #if (! $util.isNull($context.args.byAddress.state ))
    $util.qr($query.bool.must.add({ "match": { "address.state": "$context.args.byAddress.state" } }))
  #end
  #if (! $util.isNull($context.args.byAddress.zipcode ))
    $util.qr($query.bool.must.add({ "match": { "address.zipcode": "$context.args.byAddress.zipcode" } }))
  #end
#end

{
    "version":"2017-02-28",
    "operation":"GET",
    "path":"/_search",
    "params":{
        "body": {
            "query": $util.toJson($query)
        }
    }
}
</code></pre></div></div>

<p>I construct the query object inside of a map in the VTL. The initial version is provided by the <code class="highlighter-rouge">#set</code> statement at lines 1–7. Note that this must look like JSON — i.e. the fields must be quoted. I continue by setting up the filter, but only if the <em>byGPS</em> field is provided (which is signified by the value being not null). I do a similar process with the <em>byAddress</em> fields. Since the sub-fields of the <code class="highlighter-rouge">AddressInput</code> type are also optional, I need to do null checks there.</p>

<p>I did not do a “paging request” for this search capability, but should have done so. If you add <code class="highlighter-rouge">from</code> and <code class="highlighter-rouge">size</code> fields to the body of the params then you will be able to request arbitrary slices of the result set. You can use this to implement the paging request. Again, check <a href="https://github.com/adrianhall/restaurant-reviews/">the GitHub repository</a> for the details.</p>

<h2 id="the-findlocation-response-mapping-template">The findLocation response mapping template</h2>

<p>There is a shape that the response mapping template is expected to produce, and it does not match what comes back from the resolver. As a result, we have to construct it. Here is an example on what comes back from the service:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"took"</span><span class="p">:</span><span class="w"> </span><span class="mi">12</span><span class="p">,</span><span class="w">
  </span><span class="nl">"timed_out"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
  </span><span class="nl">"_shards"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="nl">"successful"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">
    </span><span class="nl">"skipped"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
    </span><span class="nl">"failed"</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"total"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
    </span><span class="nl">"max_score"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5753642</span><span class="p">,</span><span class="w">
    </span><span class="nl">"hits"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"_index"</span><span class="p">:</span><span class="w"> </span><span class="s2">"devrestaurantreviews"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"doc"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"613df4d0-1ea2-44f2-895e-698a41d1ef4a"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_score"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5753642</span><span class="p">,</span><span class="w">
        </span><span class="nl">"_source"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"owner"</span><span class="p">:</span><span class="w"> </span><span class="s2">"AIDAI6XOAOVZFVVPRZHBM"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"lastUpdated"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2018-12-03T21:31:57.878Z"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"address"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"zipcode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"98101"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"city"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Seattle"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"street"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2101 7th Ave"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"state"</span><span class="p">:</span><span class="w"> </span><span class="s2">"WA"</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The Sphere"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"typeName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"LOCATION"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"gps"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"lon"</span><span class="p">:</span><span class="w"> </span><span class="mf">-122.3340779</span><span class="p">,</span><span class="w">
            </span><span class="nl">"lat"</span><span class="p">:</span><span class="w"> </span><span class="mf">47.6147408</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"613df4d0-1ea2-44f2-895e-698a41d1ef4a"</span><span class="w">
        </span><span class="p">}</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>I can see this format by executing a query in Kibana Dev Tools. This becomes <code class="highlighter-rouge">$context.result</code> in the response mapping template. I can adjust to produce the right form as follows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#set($items = [])
#foreach($entry in $context.result.hits.hits)
  $util.qr($items.add($entry.get("_source")))
#end
{
	"items": $util.toJson($items)
}
</code></pre></div></div>

<p>Still to do here: if I want to do paging, then I have to generate a nextToken value as well and include it in the output. I’ve done these changes for paging in <a href="https://github.com/adrianhall/restaurant-reviews/">the GitHub repository</a> if you wish to take a look.</p>

<p>If you want to make the paging request for ElasticSearch work the same as for DynamoDB, then you need to convert the <code class="highlighter-rouge">nextToken</code> from a string to an integer. In velocity template language, this is done with a hack:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#set($Integer = 0)
#set($nextToken = $util.defaultIfNull($ctx.args.nextToken, "0"))
#set($from = $Integer.parseInt($nextToken))
</code></pre></div></div>

<p>You can combine the last two lines, but you must have the first <code class="highlighter-rouge">#set</code> to set up the ability to parse integers. This uses the Java <code class="highlighter-rouge">Integer.parseInt()</code> under the covers.</p>

<h2 id="conclusion">Conclusion</h2>

<p>At this point, I have an awesome GraphQL API implemented using AWS AppSync and with repeatable deployments. It supports both unauthenticated and authenticated connections (as long as the request is signed with SIGv4), and supports geospatial searches for locations, plus paged requests for my locations, reviews, and favorites.</p>

<p>There is still more to do here, and I will definitely be re-visiting this API in the future as I develop the apps for it.</p>

<p>You can find the completed API on <a href="https://github.com/adrianhall/restaurant-reviews/">my GitHub repository</a>.</p>
:ET